<div class="mis-reservas-container">
  <!-- Header con título y botón nueva reserva -->
  <mat-card class="header-card">
    <mat-card-content>
      <div class="header-content">
        <div class="header-info">
          <h1 class="page-title">
            <mat-icon>event_note</mat-icon>
            Mis Reservas
          </h1>
          <p class="subtitle">
            Total: {{ totalReservas }} reserva{{ totalReservas !== 1 ? 's' : '' }}
          </p>
        </div>
        <button mat-raised-button color="primary" (click)="nuevaReserva()">
          <mat-icon>add</mat-icon>
          Nueva Reserva
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Barra de búsqueda y filtros -->
  <mat-card class="filters-card">
    <mat-card-content>
      <!-- Búsqueda -->
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Buscar reserva...</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input matInput [formControl]="searchControl" placeholder="ID, recurso, estado...">
        <button mat-icon-button matSuffix *ngIf="searchControl.value" (click)="searchControl.setValue('')">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <!-- Filtros por estado con chips -->
      <div class="filters-section">
        <label class="filter-label">Filtrar por estado:</label>
        <mat-chip-listbox class="chip-list">
          <mat-chip-option
            *ngFor="let estado of estadosReserva"
            [color]="estadosFiltro.has(estado.valor) ? estado.color || 'primary' : ''"
            [selected]="estadosFiltro.has(estado.valor)"
            (click)="toggleEstadoFiltro(estado.valor)">
            <mat-icon matChipAvatar>{{ estado.icon }}</mat-icon>
            {{ estado.label }}
          </mat-chip-option>
        </mat-chip-listbox>
      </div>

      <!-- Botón limpiar filtros -->
      <div class="clear-filters" *ngIf="searchControl.value || estadosFiltro.size > 0">
        <button mat-button color="warn" (click)="limpiarFiltros()">
          <mat-icon>clear_all</mat-icon>
          Limpiar filtros
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Tabla de reservas -->
  <mat-card class="table-card">
    <mat-card-content>
      <!-- Loading spinner -->
      <div *ngIf="cargando" class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p class="loading-text">Cargando reservas...</p>
      </div>

      <!-- Tabla -->
      <div *ngIf="!cargando" class="table-container">
        <table mat-table [dataSource]="dataSource" matSort multiTemplateDataRows class="reservas-table">

          <!-- Expand Column -->
          <ng-container matColumnDef="expand">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let row">
              <button
                mat-icon-button
                *ngIf="row.esPaquete"
                (click)="toggleExpansion(row); $event.stopPropagation()"
                [attr.aria-label]="'Expandir paquete'">
                <mat-icon>{{ row.expandido ? 'expand_less' : 'expand_more' }}</mat-icon>
              </button>
            </td>
          </ng-container>

          <!-- ID Column -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
            <td mat-cell *matCellDef="let row">
              <div *ngIf="row.esPaquete" class="paquete-badge">
                <mat-icon class="paquete-icon">inventory_2</mat-icon>
                <strong>Paquete</strong>
              </div>
              <strong *ngIf="!row.esPaquete">#{{ row.id }}</strong>
            </td>
          </ng-container>

          <!-- Recurso Column -->
          <ng-container matColumnDef="recurso">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Recurso</th>
            <td mat-cell *matCellDef="let row">
              <div class="recurso-info">
                <div class="recurso-nombre">
                  <mat-icon *ngIf="row.esPaquete" class="package-icon">card_giftcard</mat-icon>
                  {{ row.nombreRecurso }}
                </div>
                <small class="recurso-tipo" *ngIf="!row.esPaquete">{{ formatearTipo(row.tipoReserva) }}</small>
                <small class="recurso-tipo" *ngIf="row.esPaquete">{{ row.reservas.length }} reserva(s) incluida(s)</small>
              </div>
            </td>
          </ng-container>

          <!-- Fechas Column -->
          <ng-container matColumnDef="fechas">
            <th mat-header-cell *matHeaderCellDef>Fechas</th>
            <td mat-cell *matCellDef="let row">
              <div class="fechas-info">
                <div class="fecha-item">
                  <mat-icon class="fecha-icon">event</mat-icon>
                  <small>{{ formatearFecha(row.fechaInicio) }}</small>
                </div>
                <div class="fecha-item">
                  <mat-icon class="fecha-icon">event_available</mat-icon>
                  <small>{{ formatearFecha(row.fechaFin) }}</small>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Estado Column -->
          <ng-container matColumnDef="estado">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
            <td mat-cell *matCellDef="let row">
              <mat-chip [color]="getEstadoConfig(row.estado).color || ''" class="estado-chip">
                <mat-icon matChipAvatar>{{ getEstadoConfig(row.estado).icon }}</mat-icon>
                {{ getEstadoConfig(row.estado).label }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Precio Column -->
          <ng-container matColumnDef="precio">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Precio</th>
            <td mat-cell *matCellDef="let row">
              <strong class="precio-total">{{ formatearPrecio(row.precioTotal) }}</strong>
            </td>
          </ng-container>

          <!-- Acciones Column -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef class="acciones-header">Acciones</th>
            <td mat-cell *matCellDef="let row" class="acciones-cell">
              <button mat-icon-button [matMenuTriggerFor]="menu" matTooltip="Opciones">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #menu="matMenu">
                <button mat-menu-item (click)="verDetalle(row)">
                  <mat-icon>visibility</mat-icon>
                  <span>Ver Detalle</span>
                </button>
                <button
                  mat-menu-item
                  (click)="pagarReserva(row)"
                  *ngIf="row.estado === 'PENDIENTE_PAGO' || row.estado === 'PENDIENTE'">
                  <mat-icon>payment</mat-icon>
                  <span>Pagar</span>
                </button>
                <button
                  mat-menu-item
                  (click)="cancelarReserva(row)"
                  *ngIf="row.estado === 'PENDIENTE' || row.estado === 'CONFIRMADA'">
                  <mat-icon color="warn">cancel</mat-icon>
                  <span>Cancelar</span>
                </button>
              </mat-menu>
            </td>
          </ng-container>

          <!-- Expansion Detail Row -->
          <ng-container matColumnDef="expandedDetail">
            <td mat-cell *matCellDef="let row" [attr.colspan]="displayedColumns.length" class="expansion-cell">
              <div class="expansion-detail" [@detailExpand]="row.expandido ? 'expanded' : 'collapsed'">
                <div *ngIf="row.esPaquete && row.expandido" class="paquete-details">
                  <h4 class="detail-title">
                    <mat-icon>inventory</mat-icon>
                    Detalle del Paquete
                  </h4>
                  <div class="reservas-list">
                    <div *ngFor="let reserva of row.reservas; let i = index" class="reserva-detail-card">
                      <div class="reserva-header">
                        <span class="reserva-number">#{{ i + 1 }}</span>
                        <strong>{{ reserva.nombreRecurso }}</strong>
                        <mat-chip [color]="getEstadoConfig(reserva.estadoPaquete || reserva.estado).color || ''" class="mini-chip">
                          {{ getEstadoConfig(reserva.estadoPaquete || reserva.estado).label }}
                        </mat-chip>
                      </div>
                      <div class="reserva-info-grid">
                        <div class="info-item">
                          <mat-icon>confirmation_number</mat-icon>
                          <span>ID: #{{ reserva.id }}</span>
                        </div>
                        <div class="info-item">
                          <mat-icon>category</mat-icon>
                          <span>{{ formatearTipo(reserva.tipoReserva) }}</span>
                        </div>
                        <div class="info-item">
                          <mat-icon>event</mat-icon>
                          <span>{{ formatearFecha(reserva.fechaInicio) }}</span>
                        </div>
                        <div class="info-item">
                          <mat-icon>event_available</mat-icon>
                          <span>{{ formatearFecha(reserva.fechaFin) }}</span>
                        </div>
                        <div class="info-item">
                          <mat-icon>attach_money</mat-icon>
                          <span>{{ formatearPrecio(reserva.precioTotal) }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row" [class.expanded-row]="row.expandido"></tr>
          <tr mat-row *matRowDef="let row; columns: ['expandedDetail']; when: esPaquete" class="detail-row"></tr>

          <!-- Fila de no hay datos -->
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell empty-state" [attr.colspan]="displayedColumns.length">
              <mat-icon class="empty-icon">inbox</mat-icon>
              <p class="empty-text">No se encontraron reservas</p>
              <button mat-button color="primary" (click)="limpiarFiltros()" *ngIf="searchControl.value || estadosFiltro.size > 0">
                Limpiar filtros
              </button>
            </td>
          </tr>
        </table>

        <!-- Paginador -->
        <mat-paginator
          [pageSizeOptions]="[5, 10, 25, 50]"
          [pageSize]="10"
          showFirstLastButtons
          aria-label="Seleccione página de reservas">
        </mat-paginator>
      </div>
    </mat-card-content>
  </mat-card>
</div>
