<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <!-- Header -->
      <div class="text-center mb-4">
        <h1 class="h2 fw-bold mb-2">Confirmar Reserva</h1>
        <p class="text-muted">Revisa los detalles de tu reserva antes de confirmar</p>
      </div>

      <!-- Contenedor principal -->
      <div *ngIf="reservaData">
        <!-- Información de la cabaña (para cabana simple y paquete) -->
        <div class="card border-0 shadow-sm mb-4" *ngIf="reservaData.tipo === 'cabana' || reservaData.tipo === 'paquete'">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3" *ngIf="reservaData.tipo === 'paquete'">
              <h5 class="mb-0">
                <i class="bi bi-box-seam me-2 text-primary"></i>Paquete de Reserva
              </h5>
              <span class="badge bg-info">Con descuento</span>
            </div>
            <div class="row">
              <div class="col-md-4" *ngIf="reservaData.cabana?.imagenes && reservaData.cabana.imagenes.length > 0">
                <img [src]="reservaData.cabana.imagenes[0].url"
                     [alt]="reservaData.cabana.nombre"
                     class="img-fluid rounded"
                     style="height: 150px; width: 100%; object-fit: contain; background-color: #f8f9fa;">
              </div>
              <div [class.col-md-8]="reservaData.cabana?.imagenes && reservaData.cabana.imagenes.length > 0"
                   [class.col-12]="!reservaData.cabana?.imagenes || reservaData.cabana.imagenes.length === 0">
                <h3 class="h4 mb-3">{{ reservaData.cabana?.nombre }}</h3>
                <p class="text-muted mb-2">
                  <i class="bi bi-calendar-event me-2"></i>
                  <strong>Check-in:</strong> {{ reservaData.fechaInicio | date: 'dd/MM/yyyy' }}
                </p>
                <p class="text-muted mb-2">
                  <i class="bi bi-calendar-check me-2"></i>
                  <strong>Check-out:</strong> {{ reservaData.fechaFin | date: 'dd/MM/yyyy' }}
                </p>
                <p class="text-muted mb-0">
                  <i class="bi bi-moon me-2"></i>
                  <strong>{{ reservaData.numeroNoches }}</strong> noche(s)
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Servicios incluidos en el paquete -->
        <div class="card border-0 shadow-sm mb-4" *ngIf="reservaData.tipo === 'paquete' && reservaData.servicios && reservaData.servicios.length > 0">
          <div class="card-body">
            <h5 class="card-title mb-3">
              <i class="bi bi-calendar-plus me-2"></i>Servicios Incluidos
            </h5>
            <div class="list-group list-group-flush">
              <div *ngFor="let servicio of reservaData.servicios" class="list-group-item px-0">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h6 class="mb-1">{{ servicio.nombre }}</h6>
                    <small class="text-muted d-block">
                      <i class="bi bi-calendar3 me-1"></i>{{ servicio.fecha | date: 'dd/MM/yyyy' }}
                      <i class="bi bi-clock ms-3 me-1"></i>{{ servicio.horaInicio }}
                    </small>
                    <small class="text-muted">
                      <i class="bi bi-hourglass me-1"></i>{{ servicio.duracionBloques }} bloque(s)
                    </small>
                  </div>
                  <span class="badge bg-success">Incluido</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Para servicios -->
        <div class="card border-0 shadow-sm mb-4" *ngIf="reservaData.tipo === 'servicio'">
          <div class="card-body">
            <div class="row">
              <div class="col-md-4" *ngIf="reservaData.servicio?.imagenes && reservaData.servicio.imagenes.length > 0">
                <img [src]="reservaData.servicio.imagenes[0].url"
                     [alt]="reservaData.servicio.nombre"
                     class="img-fluid rounded"
                     style="height: 150px; width: 100%; object-fit: contain; background-color: #f8f9fa;">
              </div>
              <div [class.col-md-8]="reservaData.servicio?.imagenes && reservaData.servicio.imagenes.length > 0"
                   [class.col-12]="!reservaData.servicio?.imagenes || reservaData.servicio.imagenes.length === 0">
                <h3 class="h4 mb-3">{{ reservaData.servicio?.nombre }}</h3>
                <p class="text-muted mb-2">
                  <i class="bi bi-calendar-event me-2"></i>
                  <strong>Fecha:</strong> {{ reservaData.fecha | date: 'dd/MM/yyyy' }}
                </p>
                <p class="text-muted mb-2">
                  <i class="bi bi-clock me-2"></i>
                  <strong>Hora:</strong> {{ reservaData.horaInicio }}
                </p>
                <p class="text-muted mb-0">
                  <i class="bi bi-hourglass me-2"></i>
                  <strong>Duración:</strong> {{ reservaData.cantidadBloques }} bloque(s)
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Items Adicionales (solo para cabañas y paquetes) -->
        <div class="card border-0 shadow-sm mb-4" *ngIf="(reservaData.tipo === 'cabana' || reservaData.tipo === 'paquete') && itemsDisponibles.length > 0">
          <div class="card-body">
            <h5 class="card-title mb-3">
              <i class="bi bi-plus-circle me-2"></i>Agregar Items Adicionales (Opcional)
            </h5>

            <!-- Loading -->
            <div *ngIf="cargandoItems" class="text-center py-3">
              <span class="spinner-border spinner-border-sm me-2"></span>
              <span class="text-muted">Cargando items...</span>
            </div>

            <!-- Lista de items -->
            <div *ngIf="!cargandoItems" class="row g-3">
              <div *ngFor="let item of itemsDisponibles" class="col-md-6">
                <div class="card h-100 border" [class.border-primary]="getCantidadSeleccionada(item.id) > 0">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <h6 class="mb-0">{{ item.nombre }}</h6>
                      <span class="badge bg-info">{{ item.categoria }}</span>
                    </div>
                    <p class="text-muted small mb-2">
                      Disponibles: {{ item.cantidadDisponible }}
                    </p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="text-primary fw-bold">${{ formatearPrecio(item.precioReserva) }}</span>
                      <div class="input-group" style="width: 120px;">
                        <button
                          class="btn btn-outline-secondary btn-sm"
                          type="button"
                          (click)="toggleItem(item.id, getCantidadSeleccionada(item.id) - 1)"
                          [disabled]="getCantidadSeleccionada(item.id) === 0">
                          <i class="bi bi-dash"></i>
                        </button>
                        <input
                          type="number"
                          class="form-control form-control-sm text-center"
                          [value]="getCantidadSeleccionada(item.id)"
                          [max]="item.cantidadDisponible"
                          min="0"
                          (change)="toggleItem(item.id, +$any($event.target).value)"
                          style="max-width: 50px;">
                        <button
                          class="btn btn-outline-secondary btn-sm"
                          type="button"
                          (click)="toggleItem(item.id, getCantidadSeleccionada(item.id) + 1)"
                          [disabled]="getCantidadSeleccionada(item.id) >= (item.cantidadDisponible || 0)">
                          <i class="bi bi-plus"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Resumen de precio -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body">
            <h5 class="card-title mb-3">Resumen de Precio</h5>

            <!-- Precio base cabaña -->
            <div class="d-flex justify-content-between mb-2" *ngIf="reservaData.tipo === 'cabana'">
              <span>${{ formatearPrecio(reservaData.cabana?.precioPorUnidad || 0) }} x {{ reservaData.numeroNoches }} noche(s)</span>
              <span>${{ formatearPrecio(reservaData.precioCalculado || 0) }}</span>
            </div>

            <!-- Precio base servicio -->
            <div class="d-flex justify-content-between mb-2" *ngIf="reservaData.tipo === 'servicio'">
              <span>Precio del servicio</span>
              <span>${{ formatearPrecio(reservaData.precioCalculado || 0) }}</span>
            </div>

            <!-- Items adicionales seleccionados -->
            <div *ngIf="itemsSeleccionados.size > 0">
              <small class="text-muted d-block mt-3 mb-2">Items Adicionales:</small>
              <div *ngFor="let item of itemsDisponibles" class="d-flex justify-content-between mb-1">
                <div *ngIf="getCantidadSeleccionada(item.id) > 0">
                  <small>{{ item.nombre }} x{{ getCantidadSeleccionada(item.id) }}</small>
                  <small class="text-muted ms-2">${{ formatearPrecio(item.precioReserva) }} c/u</small>
                </div>
                <small *ngIf="getCantidadSeleccionada(item.id) > 0">
                  ${{ formatearPrecio(item.precioReserva * getCantidadSeleccionada(item.id)) }}
                </small>
              </div>
            </div>

            <hr>
            <div class="d-flex justify-content-between">
              <strong>Total</strong>
              <strong class="text-primary fs-4">${{ formatearPrecio(calcularPrecioTotal()) }}</strong>
            </div>
          </div>
        </div>

        <!-- Observaciones -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body">
            <h5 class="card-title mb-3">Observaciones (Opcional)</h5>
            <textarea
              class="form-control"
              rows="3"
              [(ngModel)]="observaciones"
              placeholder="Escribe aquí cualquier comentario o solicitud especial..."></textarea>
          </div>
        </div>

        <!-- Botones de acción -->
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <button
                  class="btn btn-outline-secondary w-100"
                  (click)="cancelar()"
                  [disabled]="cargando">
                  <i class="bi bi-x-circle me-2"></i>
                  Cancelar
                </button>
              </div>
              <div class="col-md-6">
                <button
                  class="btn btn-primary w-100"
                  (click)="confirmarReserva()"
                  [disabled]="cargando">
                  <span *ngIf="!cargando">
                    <i class="bi bi-check-circle me-2"></i>
                    Confirmar Reserva
                  </span>
                  <span *ngIf="cargando">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    Procesando...
                  </span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Información adicional -->
        <div class="alert alert-info mt-4">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Nota:</strong> Tu reserva estará en estado <strong>PENDIENTE</strong> hasta que sea confirmada por el administrador. Recibirás una notificación cuando sea aprobada.
        </div>
      </div>

      <!-- Loading -->
      <div *ngIf="!reservaData" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Cargando datos de reserva...</p>
      </div>
    </div>
  </div>
</div>
