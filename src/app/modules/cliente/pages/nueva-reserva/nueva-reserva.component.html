<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">Nueva Reserva</h4>
        </div>
        <div class="card-body">
          <!-- Indicador de pasos -->
          <div class="steps-indicator mb-4">
            <div class="step" [class.active]="paso === 1" [class.completed]="paso > 1">
              <div class="step-number">1</div>
              <div class="step-label">Tipo de Reserva</div>
            </div>
            <div class="step-line" [class.completed]="paso > 1"></div>
            <div class="step" [class.active]="paso === 2" [class.completed]="paso > 2">
              <div class="step-number">2</div>
              <div class="step-label">Seleccionar y Fechas</div>
            </div>
            <div class="step-line" [class.completed]="paso > 2"></div>
            <div class="step" [class.active]="paso === 3">
              <div class="step-number">3</div>
              <div class="step-label">Confirmar</div>
            </div>
          </div>

          <!-- PASO 1: Selección de Tipo -->
          <div *ngIf="paso === 1" class="paso-content">
            <h5 class="text-center mb-4">¿Qué deseas reservar?</h5>
            <div class="row justify-content-center">
              <div class="col-md-5 mb-3">
                <div class="card tipo-card h-100" (click)="seleccionarTipo('cabana')">
                  <div class="card-body text-center">
                    <i class="bi bi-house-door fs-1 text-primary mb-3"></i>
                    <h5 class="card-title">Cabaña</h5>
                    <p class="card-text text-muted">
                      Reserva una cabaña para tu estadía
                    </p>
                  </div>
                </div>
              </div>
              <div class="col-md-5 mb-3">
                <div class="card tipo-card h-100" (click)="seleccionarTipo('servicio')">
                  <div class="card-body text-center">
                    <i class="bi bi-calendar-event fs-1 text-success mb-3"></i>
                    <h5 class="card-title">Servicio</h5>
                    <p class="card-text text-muted">
                      Reserva un servicio de entretenimiento
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- PASO 2: Formulario de Cabaña -->
          <div *ngIf="paso === 2 && tipoReserva === 'cabana'" class="paso-content">
            <h5 class="mb-4">Reserva de Cabaña</h5>
            <form [formGroup]="formCabana">
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label for="cabanaId" class="form-label">Seleccionar Cabaña *</label>
                  <select
                    id="cabanaId"
                    class="form-select"
                    formControlName="cabanaId"
                    [class.is-invalid]="formCabana.get('cabanaId')?.invalid && formCabana.get('cabanaId')?.touched">
                    <option value="">-- Seleccione una cabaña --</option>
                    <option *ngFor="let cabana of cabanas" [value]="cabana.id">
                      {{ cabana.nombre }} - Capacidad: {{ cabana.capacidadPersonas }} personas - ${{ cabana.precioPorUnidad }}/noche
                    </option>
                  </select>
                  <div class="invalid-feedback">
                    Debe seleccionar una cabaña
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <label for="fechaInicio" class="form-label">Fecha de Inicio *</label>
                  <input
                    type="date"
                    id="fechaInicio"
                    class="form-control"
                    formControlName="fechaInicio"
                    [min]="fechaMinima"
                    [class.is-invalid]="formCabana.get('fechaInicio')?.invalid && formCabana.get('fechaInicio')?.touched">
                  <div class="invalid-feedback">
                    La fecha de inicio es requerida y debe ser hoy o posterior
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <label for="fechaFin" class="form-label">Fecha de Fin *</label>
                  <input
                    type="date"
                    id="fechaFin"
                    class="form-control"
                    formControlName="fechaFin"
                    [min]="fechaMinima"
                    [class.is-invalid]="(formCabana.get('fechaFin')?.invalid && formCabana.get('fechaFin')?.touched) || formCabana.hasError('fechaFinInvalida')">
                  <div class="invalid-feedback">
                    <span *ngIf="formCabana.hasError('fechaFinInvalida')">
                      La fecha de fin debe ser posterior a la fecha de inicio
                    </span>
                    <span *ngIf="!formCabana.hasError('fechaFinInvalida')">
                      La fecha de fin es requerida
                    </span>
                  </div>
                </div>

                <div class="col-md-12 mb-3">
                  <label for="observaciones" class="form-label">Observaciones</label>
                  <textarea
                    id="observaciones"
                    class="form-control"
                    rows="3"
                    formControlName="observaciones"
                    placeholder="Ingrese cualquier solicitud especial..."></textarea>
                </div>
              </div>

              <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-secondary" (click)="volverPaso1()">
                  <i class="bi bi-arrow-left me-2"></i>Volver
                </button>
                <button
                  type="button"
                  class="btn btn-primary"
                  (click)="verificarDisponibilidad()"
                  [disabled]="formCabana.invalid || verificandoDisponibilidad">
                  <span *ngIf="verificandoDisponibilidad" class="spinner-border spinner-border-sm me-2"></span>
                  {{ verificandoDisponibilidad ? 'Verificando...' : 'Verificar Disponibilidad' }}
                  <i class="bi bi-arrow-right ms-2" *ngIf="!verificandoDisponibilidad"></i>
                </button>
              </div>
            </form>
          </div>

          <!-- PASO 2: Formulario de Servicio -->
          <div *ngIf="paso === 2 && tipoReserva === 'servicio'" class="paso-content">
            <h5 class="mb-4">Reserva de Servicio</h5>
            <form [formGroup]="formServicio">
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label for="servicioId" class="form-label">Seleccionar Servicio *</label>
                  <select
                    id="servicioId"
                    class="form-select"
                    formControlName="servicioId"
                    [class.is-invalid]="formServicio.get('servicioId')?.invalid && formServicio.get('servicioId')?.touched">
                    <option value="">-- Seleccione un servicio --</option>
                    <option *ngFor="let servicio of servicios" [value]="servicio.id">
                      {{ servicio.nombre }} - ${{ servicio.precioPorUnidad }}/hora
                    </option>
                  </select>
                  <div class="invalid-feedback">
                    Debe seleccionar un servicio
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <label for="fecha" class="form-label">Fecha *</label>
                  <input
                    type="date"
                    id="fecha"
                    class="form-control"
                    formControlName="fecha"
                    [min]="fechaMinima"
                    [class.is-invalid]="formServicio.get('fecha')?.invalid && formServicio.get('fecha')?.touched">
                  <div class="invalid-feedback">
                    La fecha es requerida y debe ser hoy o posterior
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <label for="horaInicio" class="form-label">Hora de Inicio *</label>
                  <input
                    type="time"
                    id="horaInicio"
                    class="form-control"
                    formControlName="horaInicio"
                    [class.is-invalid]="formServicio.get('horaInicio')?.invalid && formServicio.get('horaInicio')?.touched">
                  <div class="invalid-feedback">
                    La hora de inicio es requerida
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <label for="cantidadBloques" class="form-label">Duración (bloques de 1 hora) *</label>
                  <input
                    type="number"
                    id="cantidadBloques"
                    class="form-control"
                    formControlName="cantidadBloques"
                    min="1"
                    [class.is-invalid]="formServicio.get('cantidadBloques')?.invalid && formServicio.get('cantidadBloques')?.touched">
                  <div class="invalid-feedback">
                    Debe especificar al menos 1 bloque
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <label for="cantidadPersonas" class="form-label">Cantidad de Personas *</label>
                  <input
                    type="number"
                    id="cantidadPersonas"
                    class="form-control"
                    formControlName="cantidadPersonas"
                    min="1"
                    [class.is-invalid]="formServicio.get('cantidadPersonas')?.invalid && formServicio.get('cantidadPersonas')?.touched">
                  <div class="invalid-feedback">
                    Debe especificar al menos 1 persona
                  </div>
                </div>

                <div class="col-md-12 mb-3">
                  <label for="observacionesServicio" class="form-label">Observaciones</label>
                  <textarea
                    id="observacionesServicio"
                    class="form-control"
                    rows="3"
                    formControlName="observaciones"
                    placeholder="Ingrese cualquier solicitud especial..."></textarea>
                </div>
              </div>

              <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-secondary" (click)="volverPaso1()">
                  <i class="bi bi-arrow-left me-2"></i>Volver
                </button>
                <button
                  type="button"
                  class="btn btn-primary"
                  (click)="verificarDisponibilidad()"
                  [disabled]="formServicio.invalid || verificandoDisponibilidad">
                  <span *ngIf="verificandoDisponibilidad" class="spinner-border spinner-border-sm me-2"></span>
                  {{ verificandoDisponibilidad ? 'Verificando...' : 'Verificar Disponibilidad' }}
                  <i class="bi bi-arrow-right ms-2" *ngIf="!verificandoDisponibilidad"></i>
                </button>
              </div>
            </form>
          </div>

          <!-- PASO 3: Confirmación -->
          <div *ngIf="paso === 3" class="paso-content">
            <h5 class="mb-4">Confirmar Reserva</h5>

            <!-- Resumen Cabaña -->
            <div *ngIf="tipoReserva === 'cabana'" class="card mb-3">
              <div class="card-body">
                <h6 class="card-title text-primary">Resumen de tu Reserva</h6>
                <hr>
                <div class="row">
                  <div class="col-md-6">
                    <p><strong>Tipo:</strong> Cabaña</p>
                    <p><strong>Cabaña:</strong> {{ getCabanaSeleccionada()?.nombre }}</p>
                    <p><strong>Capacidad:</strong> {{ getCabanaSeleccionada()?.capacidadPersonas }} personas</p>
                  </div>
                  <div class="col-md-6">
                    <p><strong>Fecha Inicio:</strong> {{ formCabana.get('fechaInicio')?.value | date:'dd/MM/yyyy' }}</p>
                    <p><strong>Fecha Fin:</strong> {{ formCabana.get('fechaFin')?.value | date:'dd/MM/yyyy' }}</p>
                    <p><strong>Precio por Unidad:</strong> ${{ getCabanaSeleccionada()?.precioPorUnidad | number:'1.0-0' }}</p>
                  </div>
                </div>
                <div *ngIf="formCabana.get('observaciones')?.value" class="mt-2">
                  <p><strong>Observaciones:</strong></p>
                  <p class="text-muted">{{ formCabana.get('observaciones')?.value }}</p>
                </div>
              </div>
            </div>

            <!-- Resumen Servicio -->
            <div *ngIf="tipoReserva === 'servicio'" class="card mb-3">
              <div class="card-body">
                <h6 class="card-title text-success">Resumen de tu Reserva</h6>
                <hr>
                <div class="row">
                  <div class="col-md-6">
                    <p><strong>Tipo:</strong> Servicio</p>
                    <p><strong>Servicio:</strong> {{ getServicioSeleccionado()?.nombre }}</p>
                    <p><strong>Fecha:</strong> {{ formServicio.get('fecha')?.value | date:'dd/MM/yyyy' }}</p>
                    <p><strong>Hora:</strong> {{ formServicio.get('horaInicio')?.value }}</p>
                  </div>
                  <div class="col-md-6">
                    <p><strong>Duración:</strong> {{ formServicio.get('cantidadBloques')?.value }} hora(s)</p>
                    <p><strong>Personas:</strong> {{ formServicio.get('cantidadPersonas')?.value }}</p>
                    <p><strong>Precio por Unidad:</strong> ${{ getServicioSeleccionado()?.precioPorUnidad | number:'1.0-0' }}</p>
                  </div>
                </div>
                <div *ngIf="formServicio.get('observaciones')?.value" class="mt-2">
                  <p><strong>Observaciones:</strong></p>
                  <p class="text-muted">{{ formServicio.get('observaciones')?.value }}</p>
                </div>
              </div>
            </div>

            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Nota:</strong> Al confirmar la reserva, se creará con estado PENDIENTE.
              Podrás cancelarla desde "Mis Reservas" si es necesario.
            </div>

            <div class="d-flex justify-content-between mt-4">
              <button type="button" class="btn btn-secondary" (click)="volverPaso2()">
                <i class="bi bi-arrow-left me-2"></i>Volver
              </button>
              <button
                type="button"
                class="btn btn-success btn-lg"
                (click)="confirmarReserva()"
                [disabled]="creandoReserva">
                <span *ngIf="creandoReserva" class="spinner-border spinner-border-sm me-2"></span>
                <i class="bi bi-check-circle me-2" *ngIf="!creandoReserva"></i>
                {{ creandoReserva ? 'Creando Reserva...' : 'Confirmar Reserva' }}
              </button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
