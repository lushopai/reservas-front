<div class="usuario-form-container">
  <!-- Loading Spinner -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="60" color="primary"></mat-spinner>
    <p class="loading-text">Cargando información...</p>
  </div>

  <!-- Formulario -->
  <div *ngIf="!loading" class="form-wrapper">
    <!-- Header -->
    <div class="page-header">
      <div class="header-content">
        <h1 class="page-title">
          <mat-icon>{{ isEditMode ? 'edit' : 'person_add' }}</mat-icon>
          {{ isEditMode ? 'Editar Usuario' : 'Nuevo Usuario' }}
        </h1>
        <p class="page-subtitle">
          {{ isEditMode ? 'Modifica la información del usuario' : 'Completa los datos para crear un nuevo usuario' }}
        </p>
      </div>
      <div class="header-actions">
        <button mat-stroked-button (click)="volver()">
          <mat-icon>arrow_back</mat-icon>
          Volver
        </button>
      </div>
    </div>

    <!-- Formulario Card -->
    <mat-card class="form-card">
      <mat-card-content>
        <form [formGroup]="usuarioForm" (ngSubmit)="onSubmit()">

          <!-- Información Personal -->
          <div class="form-section">
            <div class="section-header">
              <mat-icon class="section-icon">badge</mat-icon>
              <h2 class="section-title">Información Personal</h2>
            </div>
            <mat-divider class="section-divider"></mat-divider>

            <div class="form-grid">
              <!-- Nombre -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Nombre</mat-label>
                <input
                  matInput
                  formControlName="nombre"
                  placeholder="Ingresa el nombre"
                  required>
                <mat-icon matPrefix>person</mat-icon>
                <mat-error *ngIf="isFieldInvalid('nombre')">
                  {{ getErrorMessage('nombre') }}
                </mat-error>
              </mat-form-field>

              <!-- Apellidos -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Apellidos</mat-label>
                <input
                  matInput
                  formControlName="apellidos"
                  placeholder="Ingresa los apellidos"
                  required>
                <mat-icon matPrefix>person</mat-icon>
                <mat-error *ngIf="isFieldInvalid('apellidos')">
                  {{ getErrorMessage('apellidos') }}
                </mat-error>
              </mat-form-field>

              <!-- Email -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Email</mat-label>
                <input
                  matInput
                  type="email"
                  formControlName="email"
                  placeholder="ejemplo@correo.com"
                  required>
                <mat-icon matPrefix>email</mat-icon>
                <mat-error *ngIf="isFieldInvalid('email')">
                  {{ getErrorMessage('email') }}
                </mat-error>
              </mat-form-field>

              <!-- Teléfono -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Teléfono</mat-label>
                <input
                  matInput
                  type="tel"
                  formControlName="telefono"
                  placeholder="912345678">
                <mat-icon matPrefix>phone</mat-icon>
                <mat-hint>9-15 dígitos sin espacios</mat-hint>
                <mat-error *ngIf="isFieldInvalid('telefono')">
                  {{ getErrorMessage('telefono') }}
                </mat-error>
              </mat-form-field>

              <!-- Tipo Documento -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Tipo de Documento</mat-label>
                <mat-select formControlName="tipoDocumento" required>
                  <mat-option value="">Selecciona un tipo</mat-option>
                  <mat-option *ngFor="let tipo of tiposDocumento" [value]="tipo.value">
                    {{ tipo.label }}
                  </mat-option>
                </mat-select>
                <mat-icon matPrefix>description</mat-icon>
                <mat-error *ngIf="isFieldInvalid('tipoDocumento')">
                  {{ getErrorMessage('tipoDocumento') }}
                </mat-error>
              </mat-form-field>

              <!-- Documento -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Número de Documento</mat-label>
                <input
                  matInput
                  formControlName="documento"
                  placeholder="Ingresa el documento"
                  required>
                <mat-icon matPrefix>credit_card</mat-icon>
                <mat-error *ngIf="isFieldInvalid('documento')">
                  {{ getErrorMessage('documento') }}
                </mat-error>
              </mat-form-field>
            </div>
          </div>

          <!-- Seguridad -->
          <div class="form-section">
            <div class="section-header">
              <mat-icon class="section-icon">lock</mat-icon>
              <h2 class="section-title">Seguridad</h2>
            </div>
            <mat-divider class="section-divider"></mat-divider>

            <div class="form-grid">
              <!-- Contraseña -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Contraseña</mat-label>
                <input
                  matInput
                  [type]="showPassword ? 'text' : 'password'"
                  formControlName="password"
                  [placeholder]="isEditMode ? 'Dejar vacío para no cambiar' : 'Mínimo 6 caracteres'"
                  [required]="!isEditMode">
                <mat-icon matPrefix>lock</mat-icon>
                <button
                  mat-icon-button
                  matSuffix
                  type="button"
                  (click)="togglePasswordVisibility()"
                  [attr.aria-label]="'Toggle password visibility'">
                  <mat-icon>{{ showPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                </button>
                <mat-hint *ngIf="isEditMode">Dejar vacío para mantener la contraseña actual</mat-hint>
                <mat-error *ngIf="isFieldInvalid('password')">
                  {{ getErrorMessage('password') }}
                </mat-error>
              </mat-form-field>

              <!-- Confirmar Contraseña -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Confirmar Contraseña</mat-label>
                <input
                  matInput
                  [type]="showConfirmPassword ? 'text' : 'password'"
                  formControlName="confirmPassword"
                  [placeholder]="isEditMode ? 'Dejar vacío para no cambiar' : 'Repite la contraseña'"
                  [required]="!isEditMode">
                <mat-icon matPrefix>lock</mat-icon>
                <button
                  mat-icon-button
                  matSuffix
                  type="button"
                  (click)="toggleConfirmPasswordVisibility()"
                  [attr.aria-label]="'Toggle password visibility'">
                  <mat-icon>{{ showConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                </button>
                <mat-error *ngIf="isFieldInvalid('confirmPassword')">
                  {{ getErrorMessage('confirmPassword') }}
                </mat-error>
              </mat-form-field>
            </div>
          </div>

          <!-- Configuración -->
          <div class="form-section">
            <div class="section-header">
              <mat-icon class="section-icon">settings</mat-icon>
              <h2 class="section-title">Configuración</h2>
            </div>
            <mat-divider class="section-divider"></mat-divider>

            <!-- Estado del Usuario -->
            <div class="switch-container">
              <mat-card class="switch-card" [class.switch-active]="usuarioForm.get('enabled')?.value">
                <mat-card-content>
                  <div class="switch-content">
                    <div class="switch-icon-wrapper">
                      <div class="switch-icon active">
                        <mat-icon>check_circle</mat-icon>
                      </div>
                    </div>
                    <div class="switch-info">
                      <h3>Usuario Activo</h3>
                      <p>El usuario podrá acceder al sistema</p>
                    </div>
                    <mat-slide-toggle
                      formControlName="enabled"
                      color="primary">
                    </mat-slide-toggle>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          </div>

          <!-- Botones de acción -->
          <div class="form-actions">
            <button
              mat-stroked-button
              type="button"
              (click)="volver()"
              [disabled]="submitting"
              class="btn-cancel">
              <mat-icon>close</mat-icon>
              Cancelar
            </button>
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="submitting"
              class="btn-submit">
              <mat-spinner
                *ngIf="submitting"
                diameter="20"
                class="button-spinner">
              </mat-spinner>
              <mat-icon *ngIf="!submitting">{{ isEditMode ? 'save' : 'add_circle' }}</mat-icon>
              {{ submitting ? 'Guardando...' : (isEditMode ? 'Guardar Cambios' : 'Crear Usuario') }}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
</div>
