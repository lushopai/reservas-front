<div class="bloques-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <mat-icon>schedule</mat-icon>
        Disponibilidad de Servicios
      </h1>
      <p class="page-subtitle">Visualiza y administra los bloques horarios disponibles para reservas</p>
    </div>
  </div>

  <!-- Tabs para cambiar de vista -->
  <mat-tab-group [(selectedIndex)]="selectedTabIndex"
                 (selectedIndexChange)="cambiarVista($event)"
                 class="tabs-container">

    <!-- TAB 1: CALENDARIO DE BLOQUES -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">calendar_month</mat-icon>
        Calendario
      </ng-template>

      <div class="tab-content">

        <!-- Selector de Servicio -->
        <div class="selector-section" *ngIf="servicios.length > 0">
          <mat-card class="selector-card">
            <mat-card-content>
              <form [formGroup]="generarForm" class="search-grid">
                <mat-form-field appearance="outline">
                  <mat-label>Servicio</mat-label>
                  <mat-select formControlName="servicioId">
                    <mat-option *ngFor="let servicio of servicios" [value]="servicio.id">
                      {{ servicio.nombre }}
                    </mat-option>
                  </mat-select>
                  <mat-icon matPrefix>celebration</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Fecha Inicio</mat-label>
                  <input matInput [matDatepicker]="pickerInicio" formControlName="fechaInicio" [min]="fechaMinima">
                  <mat-datepicker-toggle matSuffix [for]="pickerInicio"></mat-datepicker-toggle>
                  <mat-datepicker #pickerInicio></mat-datepicker>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Fecha Fin</mat-label>
                  <input matInput [matDatepicker]="pickerFin" formControlName="fechaFin" [min]="generarForm.value.fechaInicio || fechaMinima">
                  <mat-datepicker-toggle matSuffix [for]="pickerFin"></mat-datepicker-toggle>
                  <mat-datepicker #pickerFin></mat-datepicker>
                </mat-form-field>

                <button mat-raised-button color="accent"
                        (click)="cargarBloques()"
                        [disabled]="!servicioSeleccionado || !generarForm.value.fechaInicio || !generarForm.value.fechaFin"
                        class="search-button">
                  <mat-icon>search</mat-icon>
                  Buscar
                </button>
              </form>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Estadísticas -->
        <div class="stats-row" *ngIf="bloques.length > 0">
          <mat-card class="stat-card disponibles">
            <mat-card-content>
              <div class="stat-icon">
                <mat-icon>check_circle</mat-icon>
              </div>
              <div class="stat-info">
                <h3>{{ stats.disponibles }}</h3>
                <p>Disponibles</p>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="stat-card ocupados">
            <mat-card-content>
              <div class="stat-icon">
                <mat-icon>event_busy</mat-icon>
              </div>
              <div class="stat-info">
                <h3>{{ stats.ocupados }}</h3>
                <p>Ocupados</p>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="stat-card bloqueados">
            <mat-card-content>
              <div class="stat-icon">
                <mat-icon>block</mat-icon>
              </div>
              <div class="stat-info">
                <h3>{{ stats.bloqueados }}</h3>
                <p>Bloqueados</p>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="stat-card total">
            <mat-card-content>
              <div class="stat-icon">
                <mat-icon>analytics</mat-icon>
              </div>
              <div class="stat-info">
                <h3>{{ stats.porcentajeOcupacion }}%</h3>
                <p>Ocupación</p>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Loading state -->
        <div class="loading-container" *ngIf="cargando">
          <mat-spinner></mat-spinner>
          <p>Cargando bloques...</p>
        </div>

        <!-- Calendar view -->
        <div class="calendar-view" *ngIf="!cargando && bloques.length > 0">

          <div class="day-card" *ngFor="let fecha of obtenerFechasOrdenadas()">
            <div class="day-header">
              <h3>{{ formatearFecha(fecha) }}</h3>
              <span class="bloques-count">
                {{ bloquesPorDia.get(fecha)?.length || 0 }} bloques
              </span>
            </div>

            <div class="bloques-grid">
              <div *ngFor="let bloque of bloquesPorDia.get(fecha)"
                   class="bloque-card"
                   [ngClass]="getEstadoClass(bloque)">

                <div class="bloque-content">
                  <div class="bloque-time">
                    <mat-icon class="time-icon">schedule</mat-icon>
                    <span>{{ bloque.horaInicio }} - {{ bloque.horaFin }}</span>
                  </div>

                  <div class="bloque-status">
                    <mat-icon [ngClass]="getEstadoClass(bloque)">
                      {{ getEstadoIcon(bloque) }}
                    </mat-icon>
                    <span class="status-text">
                      {{ bloque.disponible ? 'Disponible' : (bloque.motivoNoDisponible === 'RESERVADO' ? 'Ocupado' : 'Bloqueado') }}
                    </span>
                  </div>

                  <div class="bloque-info" *ngIf="!bloque.disponible">
                    <small class="text-muted" *ngIf="bloque.motivoNoDisponible === 'RESERVADO'">
                      Bloque Reservado
                    </small>
                    <small class="text-muted" *ngIf="bloque.motivoNoDisponible && bloque.motivoNoDisponible !== 'RESERVADO'">
                      {{ bloque.motivoNoDisponible }}
                    </small>
                  </div>
                </div>

                <div class="bloque-actions">
                  <button mat-icon-button
                          *ngIf="bloque.disponible"
                          (click)="bloquearBloque(bloque)"
                          matTooltip="Bloquear">
                    <mat-icon>block</mat-icon>
                  </button>
                  <button mat-icon-button
                          *ngIf="!bloque.disponible && bloque.motivoNoDisponible !== 'RESERVADO'"
                          (click)="desbloquearBloque(bloque)"
                          matTooltip="Desbloquear"
                          color="primary">
                    <mat-icon>check_circle</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Empty state -->
        <div class="empty-state-large" *ngIf="!cargando && bloques.length === 0 && servicioSeleccionado">
          <mat-icon>event_available</mat-icon>
          <h3>No hay bloques en este rango</h3>
          <p>Selecciona un servicio y rango de fechas, o genera bloques desde la pestaña "Generar Bloques"</p>
          <button mat-raised-button color="accent" (click)="cambiarVista(1)">
            <mat-icon>add_circle</mat-icon>
            Generar Bloques
          </button>
        </div>

        <!-- Empty state sin servicio -->
        <div class="empty-state-large" *ngIf="!cargando && !servicioSeleccionado">
          <mat-icon>info</mat-icon>
          <h3>Selecciona un servicio</h3>
          <p>Elige un servicio para ver sus bloques horarios disponibles</p>
        </div>

      </div>
    </mat-tab>

    <!-- TAB 2: GENERAR BLOQUES -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">add_circle</mat-icon>
        Generar Bloques
      </ng-template>

      <div class="tab-content">
        <div class="generate-grid">
          <!-- Formulario de generación -->
          <div class="form-section">
            <mat-card class="form-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>settings</mat-icon>
                  Configuración de Bloques
                </mat-card-title>
                <mat-card-subtitle>Define los parámetros para generar bloques masivamente</mat-card-subtitle>
              </mat-card-header>

              <mat-card-content>
                <form [formGroup]="generarForm" class="form-fields">

                  <!-- Servicio -->
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Servicio</mat-label>
                    <mat-select formControlName="servicioId">
                      <mat-option *ngFor="let servicio of servicios" [value]="servicio.id">
                        {{ servicio.nombre }}
                      </mat-option>
                    </mat-select>
                    <mat-icon matPrefix>celebration</mat-icon>
                    <mat-hint *ngIf="servicioSeleccionado">
                      Duración por defecto: {{ servicioSeleccionado.duracionBloqueMinutos }} min
                    </mat-hint>
                  </mat-form-field>

                  <!-- Rango de fechas -->
                  <div class="form-row">
                    <mat-form-field appearance="outline">
                      <mat-label>Fecha Inicio</mat-label>
                      <input matInput [matDatepicker]="pickerFechaInicio" formControlName="fechaInicio" [min]="fechaMinima">
                      <mat-datepicker-toggle matSuffix [for]="pickerFechaInicio"></mat-datepicker-toggle>
                      <mat-datepicker #pickerFechaInicio></mat-datepicker>
                    </mat-form-field>
                    
                    <mat-form-field appearance="outline">
                      <mat-label>Fecha Fin</mat-label>
                      <input matInput [matDatepicker]="pickerFechaFin" formControlName="fechaFin" [min]="generarForm.value.fechaInicio || fechaMinima">
                      <mat-datepicker-toggle matSuffix [for]="pickerFechaFin"></mat-datepicker-toggle>
                      <mat-datepicker #pickerFechaFin></mat-datepicker>
                    </mat-form-field>
                  </div>

                  <!-- Horario de operación -->
                  <div class="form-row">
                    <mat-form-field appearance="outline">
                      <mat-label>Hora Apertura</mat-label>
                      <input matInput type="time" formControlName="horaApertura">
                      <mat-icon matPrefix>schedule</mat-icon>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Hora Cierre</mat-label>
                      <input matInput type="time" formControlName="horaCierre">
                      <mat-icon matPrefix>schedule</mat-icon>
                    </mat-form-field>
                  </div>

                  <!-- Duración del bloque -->
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Duración por bloque (minutos)</mat-label>
                    <input matInput type="number" formControlName="duracionBloqueMinutos" [min]="15" [step]="15">
                    <mat-icon matPrefix>timer</mat-icon>
                    <mat-hint>Mínimo: 15 minutos</mat-hint>
                  </mat-form-field>

                  <!-- Días de la semana -->
                  <div class="dias-semana-section">
                    <label class="section-label">Días de la semana</label>
                    <div class="dias-grid">
                      <mat-checkbox *ngFor="let dia of diasSemana"
                                    [(ngModel)]="dia.seleccionado"
                                    [ngModelOptions]="{standalone: true}"
                                    class="dia-checkbox">
                        {{ dia.nombre }}
                      </mat-checkbox>
                    </div>
                  </div>

                </form>
              </mat-card-content>

              <mat-card-actions align="end">
                <button mat-raised-button color="accent"
                        [disabled]="!generarForm.valid || generando"
                        (click)="generarBloques()">
                  <mat-icon *ngIf="!generando">add_circle</mat-icon>
                  <mat-spinner *ngIf="generando" diameter="20" class="button-spinner"></mat-spinner>
                  {{ generando ? 'Generando...' : 'Generar Bloques' }}
                </button>
              </mat-card-actions>
            </mat-card>
          </div>

          <!-- Preview y resumen -->
          <div class="preview-section">
            <mat-card class="preview-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>preview</mat-icon>
                  Resumen de Generación
                </mat-card-title>
                <mat-card-subtitle>Vista previa de los bloques a crear</mat-card-subtitle>
              </mat-card-header>

              <mat-card-content>
                <div class="preview-content">

                  <!-- Estadísticas estimadas -->
                  <div class="stat-item" *ngIf="generarForm.valid">
                    <div class="stat-icon estimate">
                      <mat-icon>calculate</mat-icon>
                    </div>
                    <div class="stat-details">
                      <h2>{{ calcularBloquesEstimados() }}</h2>
                      <p>Bloques estimados</p>
                    </div>
                  </div>

                  <mat-divider class="my-3"></mat-divider>

                  <!-- Detalles del rango -->
                  <div class="detail-list" *ngIf="generarForm.value.fechaInicio && generarForm.value.fechaFin">
                    <div class="detail-item">
                      <mat-icon>date_range</mat-icon>
                      <div>
                        <strong>Período</strong>
                        <p>{{ generarForm.value.fechaInicio | date:'shortDate' }} - {{ generarForm.value.fechaFin | date:'shortDate' }}</p>
                      </div>
                    </div>

                    <div class="detail-item">
                      <mat-icon>schedule</mat-icon>
                      <div>
                        <strong>Horario</strong>
                        <p>{{ generarForm.value.horaApertura }} - {{ generarForm.value.horaCierre }}</p>
                      </div>
                    </div>

                    <div class="detail-item">
                      <mat-icon>timer</mat-icon>
                      <div>
                        <strong>Duración</strong>
                        <p>{{ generarForm.value.duracionBloqueMinutos }} minutos por bloque</p>
                      </div>
                    </div>

                    <div class="detail-item">
                      <mat-icon>calendar_today</mat-icon>
                      <div>
                        <strong>Días seleccionados</strong>
                        <p>{{ obtenerDiasSeleccionados() }}</p>
                      </div>
                    </div>
                  </div>

                  <div class="empty-state" *ngIf="!generarForm.value.fechaInicio || !generarForm.value.fechaFin">
                    <mat-icon>info</mat-icon>
                    <p>Completa el formulario para ver el resumen</p>
                  </div>

                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>

</div>
