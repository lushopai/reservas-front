<div class="reserva-detail-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <mat-icon>event_note</mat-icon>
        Detalle de Reserva
      </h1>
      <p class="page-subtitle" *ngIf="reserva">Reserva #{{ reserva.id }}</p>
    </div>
    <div class="header-actions">
      <button mat-stroked-button (click)="volver()">
        <mat-icon>arrow_back</mat-icon>
        Volver
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="cargando" class="loading-container">
    <mat-spinner diameter="60"></mat-spinner>
    <p class="loading-text">Cargando información de la reserva...</p>
  </div>

  <!-- Contenido Principal -->
  <div *ngIf="!cargando && reserva" class="content-grid">

    <!-- Columna Izquierda -->
    <div class="left-column">

      <!-- Card: Información General -->
      <mat-card class="info-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="card-icon blue-icon">info</mat-icon>
          <mat-card-title>Información General</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-grid">
            <div class="info-item">
              <label>ID Reserva</label>
              <p class="value id-badge">#{{ reserva.id }}</p>
            </div>
            <div class="info-item">
              <label>Estado Actual</label>
              <p class="value">
                <mat-chip [class]="getEstadoChipClass(reserva.estado)">
                  <mat-icon>{{ getEstadoIcon(reserva.estado) }}</mat-icon>
                  {{ reserva.estado }}
                </mat-chip>
              </p>
            </div>
            <div class="info-item">
              <label>Tipo de Reserva</label>
              <p class="value">{{ reserva.tipoReserva === 'CABANA_DIA' ? 'Cabaña' : 'Servicio' }}</p>
            </div>
            <div class="info-item full-width" *ngIf="reserva.paqueteId">
              <label>Paquete</label>
              <p class="value">
                <mat-chip class="chip-paquete">
                  <mat-icon>card_giftcard</mat-icon>
                  {{ reserva.nombrePaquete || 'Paquete #' + reserva.paqueteId }}
                </mat-chip>
              </p>
            </div>
            <div class="info-item">
              <label>Fecha de Reserva</label>
              <p class="value">{{ reserva.fechaReserva ? formatearFecha(reserva.fechaReserva) : 'N/A' }}</p>
            </div>
            <div class="info-item full-width">
              <label>Duración</label>
              <p class="value">
                <mat-icon class="inline-icon">schedule</mat-icon>
                {{ calcularDias() }} {{ calcularDias() === 1 ? 'día' : 'días' }}
              </p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Card: Cliente -->
      <mat-card class="info-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="card-icon teal-icon">person</mat-icon>
          <mat-card-title>Información del Cliente</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-grid">
            <div class="info-item">
              <label>Nombre Completo</label>
              <p class="value">{{ reserva.nombreUsuario || 'N/A' }}</p>
            </div>
            <div class="info-item">
              <label>Email</label>
              <p class="value">
                <mat-icon class="inline-icon">email</mat-icon>
                {{ reserva.emailUsuario || 'N/A' }}
              </p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Card: Recurso -->
      <mat-card class="info-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="card-icon green-icon">holiday_village</mat-icon>
          <mat-card-title>Recurso Reservado</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-grid">
            <div class="info-item full-width">
              <label>Nombre del Recurso</label>
              <p class="value resource-name">{{ reserva.nombreRecurso || 'N/A' }}</p>
            </div>
            <div class="info-item">
              <label>Fecha Inicio</label>
              <p class="value">
                <mat-icon class="inline-icon">event</mat-icon>
                {{ formatearFechaCorta(reserva.fechaInicio) }}
              </p>
            </div>
            <div class="info-item">
              <label>Fecha Fin</label>
              <p class="value">
                <mat-icon class="inline-icon">event</mat-icon>
                {{ formatearFechaCorta(reserva.fechaFin) }}
              </p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Card: Información del Recurso (más detallada) -->
      <mat-card class="info-card" *ngIf="reserva.recurso">
        <mat-card-header>
          <mat-icon mat-card-avatar class="card-icon purple-icon">
            {{ reserva.tipoReserva === 'CABANA_DIA' ? 'cottage' : 'celebration' }}
          </mat-icon>
          <mat-card-title>Información del Recurso</mat-card-title>
          <mat-card-subtitle>{{ reserva.tipoReserva === 'CABANA_DIA' ? 'Cabaña' : 'Servicio de Entretención' }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="recurso-detail">
            <div class="recurso-info">
              <h3>{{ reserva.recurso.nombre }}</h3>
              <p class="recurso-description" *ngIf="reserva.recurso.descripcion">
                {{ reserva.recurso.descripcion }}
              </p>
              <div class="recurso-meta">
                <mat-chip class="meta-chip">
                  <mat-icon>attach_money</mat-icon>
                  {{ formatearPrecio(reserva.recurso.precioPorUnidad) }} por unidad
                </mat-chip>
                <mat-chip class="meta-chip" *ngIf="reserva.tipoReserva === 'CABANA_DIA' && reserva.recurso.capacidadPersonas">
                  <mat-icon>people</mat-icon>
                  Capacidad: {{ reserva.recurso.capacidadPersonas }} personas
                </mat-chip>
                <mat-chip class="meta-chip" *ngIf="reserva.tipoReserva === 'SERVICIO_BLOQUE' && reserva.recurso.duracionBloqueMinutos">
                  <mat-icon>schedule</mat-icon>
                  {{ reserva.recurso.duracionBloqueMinutos }} minutos por bloque
                </mat-chip>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Card: Items Adicionales -->
      <mat-card class="info-card" *ngIf="reserva.itemsReservados && reserva.itemsReservados.length > 0">
        <mat-card-header>
          <mat-icon mat-card-avatar class="card-icon orange-icon">inventory_2</mat-icon>
          <mat-card-title>Items Adicionales de esta Reserva</mat-card-title>
          <mat-card-subtitle>
            Equipamiento reservado para {{ reserva.nombreRecurso }}
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="items-table">
            <table mat-table [dataSource]="reserva.itemsReservados" class="items-table-mat">
              <ng-container matColumnDef="nombre">
                <th mat-header-cell *matHeaderCellDef>Item</th>
                <td mat-cell *matCellDef="let item">
                  <div class="item-cell">
                    <mat-icon class="item-icon">{{  getItemIcon(item.categoria) }}</mat-icon>
                    <div>
                      <div class="item-nombre">{{ item.nombreItem }}</div>
                      <div class="item-categoria" *ngIf="item.categoria">{{ item.categoria }}</div>
                    </div>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="cantidad">
                <th mat-header-cell *matHeaderCellDef>Cantidad</th>
                <td mat-cell *matCellDef="let item">
                  <span class="cantidad-badge">{{ item.cantidad }}</span>
                </td>
              </ng-container>

              <ng-container matColumnDef="precio">
                <th mat-header-cell *matHeaderCellDef>P. Unitario</th>
                <td mat-cell *matCellDef="let item">{{ item.precioUnitario ? formatearPrecio(item.precioUnitario) : 'N/A' }}</td>
              </ng-container>

              <ng-container matColumnDef="subtotal">
                <th mat-header-cell *matHeaderCellDef>Subtotal</th>
                <td mat-cell *matCellDef="let item" class="text-bold">{{ item.subtotal ? formatearPrecio(item.subtotal) : 'N/A' }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['nombre', 'cantidad', 'precio', 'subtotal']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['nombre', 'cantidad', 'precio', 'subtotal']"></tr>
            </table>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Card: Observaciones -->
      <mat-card class="info-card" *ngIf="reserva.observaciones">
        <mat-card-header>
          <mat-icon mat-card-avatar class="card-icon gray-icon">comment</mat-icon>
          <mat-card-title>Observaciones</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="observaciones-content">
            <p>{{ reserva.observaciones }}</p>
          </div>
        </mat-card-content>
      </mat-card>

    </div>

    <!-- Columna Derecha -->
    <div class="right-column">

      <!-- Card: Gestión de Estado -->
      <mat-card class="action-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="card-icon purple-icon">settings</mat-icon>
          <mat-card-title>Gestión de Estado</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="estado-actual">
            <label>Estado Actual</label>
            <div class="estado-badge-container">
              <mat-chip [class]="getEstadoChipClass(reserva.estado)" class="estado-chip-large">
                <mat-icon>{{ getEstadoIcon(reserva.estado) }}</mat-icon>
                {{ reserva.estado }}
              </mat-chip>
            </div>
          </div>

          <mat-divider class="my-divider"></mat-divider>

          <div *ngIf="estadosDisponibles.length > 0" class="cambios-estado">
            <label>Cambiar a:</label>
            <div class="estado-buttons">
              <button
                *ngFor="let estado of estadosDisponibles"
                mat-raised-button
                [color]="estado.color"
                (click)="cambiarEstado(estado.value, estado.label)"
                [disabled]="procesando"
                class="estado-button">
                <mat-icon>{{ getEstadoIcon(estado.value) }}</mat-icon>
                {{ estado.label }}
              </button>
            </div>
          </div>

          <div *ngIf="estadosDisponibles.length === 0" class="no-cambios-alert">
            <mat-icon>info</mat-icon>
            <p>No se pueden realizar cambios desde {{ reserva.estado }}</p>
          </div>

          <mat-divider class="my-divider"></mat-divider>

          <!-- Botón Cancelar -->
          <button
            *ngIf="reserva.estado !== 'CANCELADA' && reserva.estado !== 'COMPLETADA'"
            mat-raised-button
            color="warn"
            (click)="cancelarReserva()"
            [disabled]="procesando"
            class="cancel-button">
            <mat-icon>cancel</mat-icon>
            Cancelar Reserva
          </button>
        </mat-card-content>
      </mat-card>

      <!-- Card: Resumen de Precios -->
      <mat-card class="price-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="card-icon green-icon">attach_money</mat-icon>
          <mat-card-title>Resumen de Precios</mat-card-title>
          <mat-card-subtitle *ngIf="reserva.paqueteId">
            <mat-icon class="inline-icon">info</mat-icon>
            Esta reserva es parte de un paquete
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <!-- Precios de esta reserva individual -->
          <div class="price-breakdown">
            <div class="section-label" *ngIf="reserva.paqueteId">
              <strong>Precio de esta reserva individual:</strong>
            </div>
            <div class="price-item">
              <span class="price-label">Precio Base:</span>
              <span class="price-value">{{ formatearPrecio(reserva.precioBase) }}</span>
            </div>
            <div class="price-item">
              <span class="price-label">Items Adicionales:</span>
              <span class="price-value">{{ formatearPrecio(reserva.precioItems || 0) }}</span>
            </div>
            <mat-divider></mat-divider>
            <div class="price-item total">
              <span class="price-label">Subtotal Reserva:</span>
              <span class="price-value total-price">{{ formatearPrecio(reserva.precioTotal) }}</span>
            </div>
          </div>

          <!-- Precios del paquete completo (si aplica) -->
          <div class="price-breakdown package-summary" *ngIf="reserva.paqueteId && reserva.precioFinalPaquete">
            <mat-divider class="my-3"></mat-divider>
            <div class="section-label">
              <mat-icon class="inline-icon">card_giftcard</mat-icon>
              <strong>Desglose completo del paquete:</strong>
            </div>

            <!-- Tabla de desglose de todas las reservas del paquete -->
            <div class="package-breakdown-table" *ngIf="reserva.reservasPaquete && reserva.reservasPaquete.length > 0">
              <table class="breakdown-table">
                <thead>
                  <tr>
                    <th>Recurso</th>
                    <th>Tipo</th>
                    <th class="text-right">Base</th>
                    <th class="text-right">Items</th>
                    <th class="text-right">Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let reservaPaq of reserva.reservasPaquete"
                      [class.current-reserva]="reservaPaq.id === reserva.id">
                    <td>
                      <div class="recurso-cell">
                        <mat-icon class="recurso-icon">
                          {{ reservaPaq.tipoReserva === 'CABANA_DIA' ? 'cottage' : 'celebration' }}
                        </mat-icon>
                        <span>{{ reservaPaq.nombreRecurso }}</span>
                        <mat-chip class="chip-current" *ngIf="reservaPaq.id === reserva.id">
                          <mat-icon>visibility</mat-icon>
                          Vista actual
                        </mat-chip>
                      </div>
                    </td>
                    <td>
                      <span class="tipo-badge" [class.tipo-cabana]="reservaPaq.tipoReserva === 'CABANA_DIA'">
                        {{ reservaPaq.tipoReserva === 'CABANA_DIA' ? 'Cabaña' : 'Servicio' }}
                      </span>
                    </td>
                    <td class="text-right">{{ formatearPrecio(reservaPaq.precioBase) }}</td>
                    <td class="text-right">
                      <span [class.has-items]="reservaPaq.cantidadItems > 0">
                        {{ formatearPrecio(reservaPaq.precioItems) }}
                        <span class="items-count" *ngIf="reservaPaq.cantidadItems > 0">
                          ({{ reservaPaq.cantidadItems }})
                        </span>
                      </span>
                    </td>
                    <td class="text-right text-bold">{{ formatearPrecio(reservaPaq.precioTotal) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <mat-divider class="my-2"></mat-divider>

            <!-- Resumen de precios del paquete -->
            <div class="price-item">
              <span class="price-label">Total Paquete:</span>
              <span class="price-value">{{ formatearPrecio(reserva.precioTotalPaquete || 0) }}</span>
            </div>
            <div class="price-item" *ngIf="reserva.descuentoPaquete && reserva.descuentoPaquete > 0">
              <span class="price-label">Descuento:</span>
              <span class="price-value text-success">-{{ formatearPrecio(reserva.descuentoPaquete) }}</span>
            </div>
            <mat-divider></mat-divider>
            <div class="price-item total package-total">
              <span class="price-label">Total Final Paquete:</span>
              <span class="price-value total-price">{{ formatearPrecio(reserva.precioFinalPaquete) }}</span>
            </div>
            <div class="info-note">
              <mat-icon>info</mat-icon>
              <small>Este paquete incluye {{ reserva.reservasPaquete?.length || 0 }} reserva(s)</small>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

    </div>

  </div>

  <!-- Overlay de Procesamiento -->
  <div *ngIf="procesando" class="processing-overlay">
    <div class="processing-content">
      <mat-spinner diameter="60" color="accent"></mat-spinner>
      <p>Procesando cambio de estado...</p>
    </div>
  </div>
</div>
