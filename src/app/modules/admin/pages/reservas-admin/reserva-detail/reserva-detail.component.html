<div class="reserva-detail-container">
  <!-- Header Mejorado -->
  <div class="page-header-new">
    <div class="header-left">
      <button mat-icon-button (click)="volver()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-info">
        <h1 class="page-title">
          <mat-icon>event_note</mat-icon>
          Reserva #{{ reserva?.id }}
        </h1>
        <p class="page-subtitle" *ngIf="reserva">
          {{ reserva.tipoReserva === 'CABANA_DIA' ? 'Cabaña' : 'Servicio' }}
          <span *ngIf="reserva.paqueteId" class="paquete-badge">
            <mat-icon>card_giftcard</mat-icon>
            Parte de Paquete
          </span>
        </p>
      </div>
    </div>
    <div class="header-right" *ngIf="reserva">
      <mat-chip [class]="getEstadoChipClass(reserva.estado)" class="estado-chip-header">
        <mat-icon>{{ getEstadoIcon(reserva.estado) }}</mat-icon>
        {{ reserva.estado }}
      </mat-chip>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="cargando" class="loading-container">
    <mat-spinner diameter="60"></mat-spinner>
    <p class="loading-text">Cargando información de la reserva...</p>
  </div>

  <!-- Contenido Principal -->
  <div *ngIf="!cargando && reserva" class="main-content">
    
    <!-- Hero Card -->
    <mat-card class="hero-card">
      <mat-card-content>
        <div class="hero-grid">
          <!-- Información Principal (sin imagen por ahora) -->
          <div class="hero-info">
            <div class="resource-header">
              <mat-icon class="resource-icon">
                {{ reserva.tipoReserva === 'CABANA_DIA' ? 'cottage' : 'celebration' }}
              </mat-icon>
              <div>
                <h2 class="resource-name">{{ reserva.nombreRecurso }}</h2>
                <p class="resource-type">
                  {{ reserva.tipoReserva === 'CABANA_DIA' ? 'Cabaña' : 'Servicio de Entretención' }}
                </p>
              </div>
            </div>

            <div class="hero-details">
              <!-- Fechas -->
              <div class="detail-item">
                <mat-icon>event</mat-icon>
                <div>
                  <label>Período</label>
                  <p>{{ formatearFechaCorta(reserva.fechaInicio) }} - {{ formatearFechaCorta(reserva.fechaFin) }}</p>
                </div>
              </div>

              <!-- Duración -->
              <div class="detail-item">
                <mat-icon>schedule</mat-icon>
                <div>
                  <label>Duración</label>
                  <p>{{ calcularDias() }} {{ calcularDias() === 1 ? 'día' : 'días' }}</p>
                </div>
              </div>

              <!-- Cliente -->
              <div class="detail-item">
                <mat-icon>person</mat-icon>
                <div>
                  <label>Cliente</label>
                  <p>{{ reserva.nombreUsuario }}</p>
                </div>
              </div>
            </div>

            <!-- Precio Total Destacado -->
            <div class="hero-price">
              <label>Total</label>
              <h3 class="price-amount">{{ formatearPrecio(reserva.precioTotal) }}</h3>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Grid de Contenido y Sidebar -->
    <div class="content-grid-new">
      
      <!-- Columna Principal (Tabs) -->
      <div class="main-column">
        <mat-card>
          <mat-tab-group [(selectedIndex)]="selectedTabIndex">
            
            <!-- Tab 1: Detalles -->
            <mat-tab label="Detalles">
              <ng-template mat-tab-label>
                <mat-icon class="tab-icon">info</mat-icon>
                Detalles
              </ng-template>
              
              <div class="tab-content">
                <!-- Información General -->
                <div class="section">
                  <h3 class="section-title">Información General</h3>
                  <div class="info-grid-compact">
                    <div class="info-item-compact">
                      <label>ID Reserva</label>
                      <p>#{{ reserva.id }}</p>
                    </div>
                    <div class="info-item-compact">
                      <label>Fecha de Reserva</label>
                      <p>{{ reserva.fechaReserva ? formatearFecha(reserva.fechaReserva) : 'N/A' }}</p>
                    </div>
                    <div class="info-item-compact">
                      <label>Tipo</label>
                      <p>{{ reserva.tipoReserva === 'CABANA_DIA' ? 'Cabaña' : 'Servicio' }}</p>
                    </div>
                    <div class="info-item-compact" *ngIf="reserva.paqueteId">
                      <label>Paquete</label>
                      <p>{{ reserva.nombrePaquete || 'Paquete #' + reserva.paqueteId }}</p>
                    </div>
                  </div>
                </div>

                <!-- Detalles del Recurso -->
                <div class="section" *ngIf="reserva.recurso">
                  <h3 class="section-title">Detalles del Recurso</h3>
                  <p class="resource-description" *ngIf="reserva.recurso.descripcion">
                    {{ reserva.recurso.descripcion }}
                  </p>
                  <div class="resource-meta">
                    <mat-chip class="meta-chip">
                      <mat-icon>attach_money</mat-icon>
                      {{ formatearPrecio(reserva.recurso.precioPorUnidad) }} por unidad
                    </mat-chip>
                    <mat-chip class="meta-chip" *ngIf="reserva.tipoReserva === 'CABANA_DIA' && reserva.recurso.capacidadPersonas">
                      <mat-icon>people</mat-icon>
                      Capacidad: {{ reserva.recurso.capacidadPersonas }} personas
                    </mat-chip>
                    <mat-chip class="meta-chip" *ngIf="reserva.tipoReserva === 'SERVICIO_BLOQUE' && reserva.recurso.duracionBloqueMinutos">
                      <mat-icon>schedule</mat-icon>
                      {{ reserva.recurso.duracionBloqueMinutos }} minutos por bloque
                    </mat-chip>
                  </div>
                </div>

                <!-- Observaciones -->
                <div class="section" *ngIf="reserva.observaciones">
                  <h3 class="section-title">Observaciones del Cliente</h3>
                  <div class="observaciones-box">
                    <mat-icon>comment</mat-icon>
                    <p>{{ reserva.observaciones }}</p>
                  </div>
                </div>
              </div>
            </mat-tab>

            <!-- Tab 2: Servicios del Paquete (solo si es paquete) -->
            <mat-tab *ngIf="reserva.paqueteId && reserva.reservasPaquete && reserva.reservasPaquete.length > 0" label="Servicios del Paquete">
              <ng-template mat-tab-label>
                <mat-icon class="tab-icon">card_giftcard</mat-icon>
                Servicios del Paquete
              </ng-template>
              
              <div class="tab-content">
                <div class="section">
                  <h3 class="section-title">Composición del Paquete</h3>
                  <p class="section-subtitle">Este paquete incluye {{ reserva.reservasPaquete.length }} reserva(s)</p>
                  
                  <div class="paquete-items">
                    <div *ngFor="let reservaPaq of reserva.reservasPaquete" 
                         class="paquete-item"
                         [class.current-item]="reservaPaq.id === reserva.id"
                         (click)="verReserva(reservaPaq.id)"
                         style="cursor: pointer;">
                      <div class="paquete-item-header">
                        <mat-icon class="item-type-icon">
                          {{ reservaPaq.tipoReserva === 'CABANA_DIA' ? 'cottage' : 'celebration' }}
                        </mat-icon>
                        <div class="item-info">
                          <h4>{{ reservaPaq.nombreRecurso }}</h4>
                          <span class="item-type-badge" [class.tipo-cabana]="reservaPaq.tipoReserva === 'CABANA_DIA'">
                            {{ reservaPaq.tipoReserva === 'CABANA_DIA' ? 'Cabaña' : 'Servicio' }}
                          </span>
                          <mat-chip class="chip-current" *ngIf="reservaPaq.id === reserva.id">
                            <mat-icon>visibility</mat-icon>
                            Vista actual
                          </mat-chip>
                          <button mat-stroked-button color="primary" class="ms-2" *ngIf="reservaPaq.id !== reserva.id">
                            <mat-icon>visibility</mat-icon>
                            Ver Detalle
                          </button>
                        </div>
                        <div class="item-price">
                          <span class="price-label">Subtotal</span>
                          <span class="price-value">{{ formatearPrecio(reservaPaq.precioTotal) }}</span>
                        </div>
                      </div>
                      
                      <div class="paquete-item-details">
                        <div class="detail-row">
                          <mat-icon>event</mat-icon>
                          <span>Reserva #{{ reservaPaq.id }}</span>
                        </div>
                        <div class="detail-row" *ngIf="reservaPaq.cantidadItems > 0">
                          <mat-icon>inventory_2</mat-icon>
                          <span>{{ reservaPaq.cantidadItems }} item(s) adicionales - {{ formatearPrecio(reservaPaq.precioItems) }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </mat-tab>

            <!-- Tab 3: Items Adicionales -->
            <mat-tab *ngIf="reserva.itemsReservados && reserva.itemsReservados.length > 0" label="Items Adicionales">
              <ng-template mat-tab-label>
                <mat-icon class="tab-icon">inventory_2</mat-icon>
                Items ({{ reserva.itemsReservados.length }})
              </ng-template>
              
              <div class="tab-content">
                <div class="section">
                  <h3 class="section-title">Items Adicionales Reservados</h3>
                  
                  <table mat-table [dataSource]="reserva.itemsReservados" class="items-table-modern">
                    <ng-container matColumnDef="nombre">
                      <th mat-header-cell *matHeaderCellDef>Item</th>
                      <td mat-cell *matCellDef="let item">
                        <div class="item-cell">
                          <mat-icon class="item-icon">{{ getItemIcon(item.categoria) }}</mat-icon>
                          <div>
                            <div class="item-nombre">{{ item.nombreItem }}</div>
                            <div class="item-categoria" *ngIf="item.categoria">{{ item.categoria }}</div>
                          </div>
                        </div>
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="cantidad">
                      <th mat-header-cell *matHeaderCellDef>Cantidad</th>
                      <td mat-cell *matCellDef="let item">
                        <span class="cantidad-badge">{{ item.cantidad }}</span>
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="precio">
                      <th mat-header-cell *matHeaderCellDef>P. Unitario</th>
                      <td mat-cell *matCellDef="let item">{{ formatearPrecio(item.precioUnitario || 0) }}</td>
                    </ng-container>

                    <ng-container matColumnDef="subtotal">
                      <th mat-header-cell *matHeaderCellDef>Subtotal</th>
                      <td mat-cell *matCellDef="let item" class="text-bold">{{ formatearPrecio(item.subtotal || 0) }}</td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="['nombre', 'cantidad', 'precio', 'subtotal']"></tr>
                    <tr mat-row *matRowDef="let row; columns: ['nombre', 'cantidad', 'precio', 'subtotal']"></tr>
                  </table>
                </div>
              </div>
            </mat-tab>

          </mat-tab-group>
        </mat-card>
      </div>

      <!-- Sidebar -->
      <div class="sidebar-column">
        
        <!-- Card: Gestión de Estado -->
        <mat-card class="sidebar-card">
          <mat-card-header>
            <mat-icon mat-card-avatar class="card-icon-sidebar">settings</mat-icon>
            <mat-card-title>Gestión de Estado</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="estado-actual-sidebar">
              <label>Estado Actual</label>
              <mat-chip [class]="getEstadoChipClass(reserva.estado)" class="estado-chip-large">
                <mat-icon>{{ getEstadoIcon(reserva.estado) }}</mat-icon>
                {{ reserva.estado }}
              </mat-chip>
            </div>

            <mat-divider class="my-3"></mat-divider>

            <div *ngIf="estadosDisponibles.length > 0" class="cambios-estado">
              <label>Cambiar a:</label>
              <div class="estado-buttons">
                <button
                  *ngFor="let estado of estadosDisponibles"
                  mat-raised-button
                  [color]="estado.color"
                  (click)="cambiarEstado(estado.value, estado.label)"
                  [disabled]="procesando"
                  class="estado-button">
                  <mat-icon>{{ getEstadoIcon(estado.value) }}</mat-icon>
                  {{ estado.label }}
                </button>
              </div>
            </div>

            <div *ngIf="estadosDisponibles.length === 0" class="no-cambios-alert">
              <mat-icon>info</mat-icon>
              <p>No se pueden realizar cambios desde {{ reserva.estado }}</p>
            </div>

            <mat-divider class="my-3"></mat-divider>

            <!-- Botón Cancelar -->
            <button
              *ngIf="reserva.estado !== 'CANCELADA' && reserva.estado !== 'COMPLETADA'"
              mat-raised-button
              color="warn"
              (click)="cancelarReserva()"
              [disabled]="procesando"
              class="cancel-button-full">
              <mat-icon>cancel</mat-icon>
              Cancelar Reserva
            </button>
          </mat-card-content>
        </mat-card>

        <!-- Card: Resumen de Precios -->
        <mat-card class="sidebar-card">
          <mat-card-header>
            <mat-icon mat-card-avatar class="card-icon-sidebar green">attach_money</mat-icon>
            <mat-card-title>Resumen de Precios</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="price-breakdown-sidebar">
              <div class="price-item">
                <span>Precio Base:</span>
                <span>{{ formatearPrecio(reserva.precioBase) }}</span>
              </div>
              <div class="price-item" *ngIf="reserva.precioItems && reserva.precioItems > 0">
                <span>Items Adicionales:</span>
                <span>{{ formatearPrecio(reserva.precioItems) }}</span>
              </div>
              <mat-divider class="my-2"></mat-divider>
              <div class="price-item total">
                <span>Total:</span>
                <span class="total-amount">{{ formatearPrecio(reserva.precioTotal) }}</span>
              </div>
            </div>

            <!-- Info de paquete -->
            <div class="package-info" *ngIf="reserva.paqueteId && reserva.precioFinalPaquete">
              <mat-divider class="my-3"></mat-divider>
              <div class="package-label">
                <mat-icon>card_giftcard</mat-icon>
                <span>Total del Paquete Completo:</span>
              </div>
              <div class="package-total">
                {{ formatearPrecio(reserva.precioFinalPaquete) }}
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Card: Cliente -->
        <mat-card class="sidebar-card">
          <mat-card-header>
            <mat-icon mat-card-avatar class="card-icon-sidebar teal">person</mat-icon>
            <mat-card-title>Cliente</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="cliente-info">
              <div class="cliente-avatar">
                <mat-icon>account_circle</mat-icon>
              </div>
              <div class="cliente-details">
                <h4>{{ reserva.nombreUsuario }}</h4>
                <p>
                  <mat-icon>email</mat-icon>
                  {{ reserva.emailUsuario }}
                </p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

      </div>

    </div>

  </div>

  <!-- Overlay de Procesamiento -->
  <div *ngIf="procesando" class="processing-overlay">
    <div class="processing-content">
      <mat-spinner diameter="60" color="accent"></mat-spinner>
      <p>Procesando cambio de estado...</p>
    </div>
  </div>
</div>
