<div class="reserva-form-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <mat-icon>add_circle</mat-icon>
        Nueva Reserva
      </h1>
      <p class="page-subtitle">Crear una reserva manualmente desde el panel administrativo</p>
    </div>
    <div class="header-actions">
      <button mat-stroked-button (click)="cancelar()">
        <mat-icon>arrow_back</mat-icon>
        Volver
      </button>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="cargando" class="loading-overlay">
    <mat-spinner diameter="60"></mat-spinner>
    <p class="loading-text">Procesando reserva...</p>
  </div>

  <!-- Paso 1: Seleccionar tipo de reserva -->
  <mat-card class="step-card" *ngIf="!tipoSeleccionado">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>category</mat-icon>
        Seleccione el tipo de reserva
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="tipoReservaForm">
        <div class="tipo-selection">
          <mat-card class="tipo-card" (click)="tipoReservaForm.patchValue({tipo: 'cabana'})">
            <mat-card-content>
              <mat-icon class="tipo-icon">holiday_village</mat-icon>
              <h3>Reserva de Cabaña</h3>
              <p>Para alojamiento por días</p>
            </mat-card-content>
          </mat-card>

          <mat-card class="tipo-card" (click)="tipoReservaForm.patchValue({tipo: 'servicio'})">
            <mat-card-content>
              <mat-icon class="tipo-icon">room_service</mat-icon>
              <h3>Reserva de Servicio</h3>
              <p>Para actividades por bloques horarios</p>
            </mat-card-content>
          </mat-card>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Paso 2: Formulario de reserva de cabaña -->
  <div *ngIf="tipoSeleccionado === 'cabana'">
    <mat-card class="form-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>holiday_village</mat-icon>
          Reserva de Cabaña
        </mat-card-title>
        <button mat-icon-button (click)="tipoSeleccionado = null" matTooltip="Cambiar tipo">
          <mat-icon>edit</mat-icon>
        </button>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="reservaCabanaForm">
          <div class="form-grid">
            <!-- Cliente -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Cliente</mat-label>
              <mat-select formControlName="clienteId" required>
                <mat-option *ngFor="let usuario of usuarios" [value]="usuario.id">
                  {{ usuario.nombres }} {{ usuario.apellidos }} - {{ usuario.email }}
                </mat-option>
              </mat-select>
              <mat-icon matPrefix>person</mat-icon>
              <mat-error *ngIf="reservaCabanaForm.get('clienteId')?.hasError('required')">
                El cliente es requerido
              </mat-error>
            </mat-form-field>

            <!-- Cabaña -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Cabaña</mat-label>
              <mat-select formControlName="cabanaId" required>
                <mat-option *ngFor="let cabana of cabanas" [value]="cabana.id">
                  {{ cabana.nombre }} - {{ formatearPrecio(cabana.precioPorUnidad) }}/día
                  ({{ cabana.numeroHabitaciones }} hab, {{ cabana.capacidadPersonas }} pers)
                </mat-option>
              </mat-select>
              <mat-icon matPrefix>cottage</mat-icon>
              <mat-error *ngIf="reservaCabanaForm.get('cabanaId')?.hasError('required')">
                La cabaña es requerida
              </mat-error>
            </mat-form-field>

            <!-- Fecha Inicio -->
            <mat-form-field appearance="outline">
              <mat-label>Fecha de Inicio</mat-label>
              <input matInput type="date" formControlName="fechaInicio" [min]="minDate" required>
              <mat-icon matPrefix>event</mat-icon>
              <mat-error *ngIf="reservaCabanaForm.get('fechaInicio')?.hasError('required')">
                La fecha de inicio es requerida
              </mat-error>
            </mat-form-field>

            <!-- Fecha Fin -->
            <mat-form-field appearance="outline">
              <mat-label>Fecha de Fin</mat-label>
              <input matInput type="date" formControlName="fechaFin" [min]="minDate" required>
              <mat-icon matPrefix>event</mat-icon>
              <mat-error *ngIf="reservaCabanaForm.get('fechaFin')?.hasError('required')">
                La fecha de fin es requerida
              </mat-error>
            </mat-form-field>

            <!-- Observaciones -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Observaciones</mat-label>
              <textarea matInput formControlName="observaciones" rows="3" maxlength="500"></textarea>
              <mat-icon matPrefix>note</mat-icon>
              <mat-hint align="end">{{ reservaCabanaForm.get('observaciones')?.value?.length || 0 }}/500</mat-hint>
            </mat-form-field>
          </div>
        </form>

        <!-- Items adicionales -->
        <div class="items-section">
          <div class="section-header">
            <h3>
              <mat-icon>inventory_2</mat-icon>
              Items Adicionales
            </h3>
            <button mat-raised-button color="accent" (click)="agregarItem()">
              <mat-icon>add</mat-icon>
              Agregar Item
            </button>
          </div>

          <div *ngIf="itemsSeleccionados.length > 0" class="items-list">
            <mat-chip-listbox>
              <mat-chip *ngFor="let item of itemsSeleccionados; let i = index" (removed)="eliminarItem(i)">
                {{ getNombreItem(item.itemId) }} (x{{ item.cantidad }})
                <button matChipRemove>
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip>
            </mat-chip-listbox>
          </div>

          <p *ngIf="itemsSeleccionados.length === 0" class="empty-message">
            No se han agregado items adicionales
          </p>
        </div>

        <!-- Resumen -->
        <div *ngIf="cabanaSeleccionada && reservaCabanaForm.get('fechaInicio')?.value && reservaCabanaForm.get('fechaFin')?.value" class="resumen-section">
          <mat-divider></mat-divider>
          <h3>Resumen de Costos</h3>
          <div class="resumen-item">
            <span>Precio por día:</span>
            <span class="precio">{{ formatearPrecio(cabanaSeleccionada.precioPorUnidad) }}</span>
          </div>
          <div class="resumen-item">
            <span>Días:</span>
            <span>{{ calcularDias(reservaCabanaForm.get('fechaInicio')?.value, reservaCabanaForm.get('fechaFin')?.value) }}</span>
          </div>
          <div class="resumen-item total">
            <span>Total Estimado:</span>
            <span class="precio">{{ formatearPrecio(calcularPrecioEstimado()) }}</span>
          </div>
          <mat-hint>* El precio final puede variar según items adicionales y otros cargos</mat-hint>
        </div>
      </mat-card-content>
      <mat-card-actions align="end">
        <button mat-stroked-button (click)="cancelar()">
          <mat-icon>close</mat-icon>
          Cancelar
        </button>
        <button mat-raised-button color="primary" (click)="crearReserva()" [disabled]="reservaCabanaForm.invalid || cargando">
          <mat-icon>save</mat-icon>
          Crear Reserva
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- Paso 2: Formulario de reserva de servicio -->
  <div *ngIf="tipoSeleccionado === 'servicio'">
    <mat-card class="form-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>room_service</mat-icon>
          Reserva de Servicio
        </mat-card-title>
        <button mat-icon-button (click)="tipoSeleccionado = null" matTooltip="Cambiar tipo">
          <mat-icon>edit</mat-icon>
        </button>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="reservaServicioForm">
          <div class="form-grid">
            <!-- Cliente -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Cliente</mat-label>
              <mat-select formControlName="clienteId" required>
                <mat-option *ngFor="let usuario of usuarios" [value]="usuario.id">
                  {{ usuario.nombres }} {{ usuario.apellidos }} - {{ usuario.email }}
                </mat-option>
              </mat-select>
              <mat-icon matPrefix>person</mat-icon>
              <mat-error *ngIf="reservaServicioForm.get('clienteId')?.hasError('required')">
                El cliente es requerido
              </mat-error>
            </mat-form-field>

            <!-- Servicio -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Servicio</mat-label>
              <mat-select formControlName="servicioId" required>
                <mat-option *ngFor="let servicio of servicios" [value]="servicio.id">
                  {{ servicio.nombre }} - {{ formatearPrecio(servicio.precioPorUnidad) }}/bloque
                  ({{ servicio.duracionBloqueMinutos }} min, cap: {{ servicio.capacidadMaxima }})
                </mat-option>
              </mat-select>
              <mat-icon matPrefix>sports_tennis</mat-icon>
              <mat-error *ngIf="reservaServicioForm.get('servicioId')?.hasError('required')">
                El servicio es requerido
              </mat-error>
            </mat-form-field>

            <!-- Fecha -->
            <mat-form-field appearance="outline">
              <mat-label>Fecha</mat-label>
              <input matInput type="date" formControlName="fecha" [min]="minDate" required>
              <mat-icon matPrefix>event</mat-icon>
              <mat-error *ngIf="reservaServicioForm.get('fecha')?.hasError('required')">
                La fecha es requerida
              </mat-error>
            </mat-form-field>

            <!-- Hora de Inicio -->
            <mat-form-field appearance="outline">
              <mat-label>Hora de Inicio</mat-label>
              <mat-select formControlName="horaInicio" required>
                <mat-option *ngFor="let hora of horariosDisponibles" [value]="hora">
                  {{ hora }}
                </mat-option>
              </mat-select>
              <mat-icon matPrefix>schedule</mat-icon>
              <mat-error *ngIf="reservaServicioForm.get('horaInicio')?.hasError('required')">
                La hora es requerida
              </mat-error>
            </mat-form-field>

            <!-- Duración en Bloques -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Duración (bloques)</mat-label>
              <input matInput type="number" formControlName="duracionBloques" min="1" max="10" required>
              <mat-icon matPrefix>timelapse</mat-icon>
              <mat-hint *ngIf="servicioSeleccionado">
                1 bloque = {{ servicioSeleccionado.duracionBloqueMinutos }} minutos
              </mat-hint>
              <mat-error *ngIf="reservaServicioForm.get('duracionBloques')?.hasError('required')">
                La duración es requerida
              </mat-error>
              <mat-error *ngIf="reservaServicioForm.get('duracionBloques')?.hasError('min')">
                Mínimo 1 bloque
              </mat-error>
              <mat-error *ngIf="reservaServicioForm.get('duracionBloques')?.hasError('max')">
                Máximo 10 bloques
              </mat-error>
            </mat-form-field>

            <!-- Observaciones -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Observaciones</mat-label>
              <textarea matInput formControlName="observaciones" rows="3" maxlength="500"></textarea>
              <mat-icon matPrefix>note</mat-icon>
              <mat-hint align="end">{{ reservaServicioForm.get('observaciones')?.value?.length || 0 }}/500</mat-hint>
            </mat-form-field>
          </div>
        </form>

        <!-- Equipamiento adicional -->
        <div class="items-section">
          <div class="section-header">
            <h3>
              <mat-icon>inventory_2</mat-icon>
              Equipamiento Adicional
            </h3>
            <button mat-raised-button color="accent" (click)="agregarItem()">
              <mat-icon>add</mat-icon>
              Agregar Item
            </button>
          </div>

          <div *ngIf="itemsSeleccionados.length > 0" class="items-list">
            <mat-chip-listbox>
              <mat-chip *ngFor="let item of itemsSeleccionados; let i = index" (removed)="eliminarItem(i)">
                {{ getNombreItem(item.itemId) }} (x{{ item.cantidad }})
                <button matChipRemove>
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip>
            </mat-chip-listbox>
          </div>

          <p *ngIf="itemsSeleccionados.length === 0" class="empty-message">
            No se ha agregado equipamiento adicional
          </p>
        </div>

        <!-- Resumen -->
        <div *ngIf="servicioSeleccionado && reservaServicioForm.get('duracionBloques')?.value" class="resumen-section">
          <mat-divider></mat-divider>
          <h3>Resumen de Costos</h3>
          <div class="resumen-item">
            <span>Precio por bloque:</span>
            <span class="precio">{{ formatearPrecio(servicioSeleccionado.precioPorUnidad) }}</span>
          </div>
          <div class="resumen-item">
            <span>Bloques:</span>
            <span>{{ reservaServicioForm.get('duracionBloques')?.value }}</span>
          </div>
          <div class="resumen-item">
            <span>Duración total:</span>
            <span>{{ servicioSeleccionado.duracionBloqueMinutos * reservaServicioForm.get('duracionBloques')?.value }} minutos</span>
          </div>
          <div class="resumen-item total">
            <span>Total Estimado:</span>
            <span class="precio">{{ formatearPrecio(calcularPrecioEstimado()) }}</span>
          </div>
          <mat-hint>* El precio final puede variar según equipamiento adicional y otros cargos</mat-hint>
        </div>
      </mat-card-content>
      <mat-card-actions align="end">
        <button mat-stroked-button (click)="cancelar()">
          <mat-icon>close</mat-icon>
          Cancelar
        </button>
        <button mat-raised-button color="primary" (click)="crearReserva()" [disabled]="reservaServicioForm.invalid || cargando">
          <mat-icon>save</mat-icon>
          Crear Reserva
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>
