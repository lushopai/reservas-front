<app-public-navbar></app-public-navbar>

<!-- Loading State -->
<div *ngIf="cargando" class="loading-container">
  <mat-spinner diameter="60"></mat-spinner>
  <p class="loading-text">Cargando información...</p>
</div>

<!-- Main Content -->
<div *ngIf="!cargando && cabana" class="detalle-container">

  <!-- Breadcrumb Material -->
  <nav class="breadcrumb-nav">
    <a routerLink="/" class="breadcrumb-link">
      <mat-icon>home</mat-icon>
      Inicio
    </a>
    <mat-icon class="breadcrumb-separator">chevron_right</mat-icon>
    <a routerLink="/cabanas" class="breadcrumb-link">Cabañas</a>
    <mat-icon class="breadcrumb-separator">chevron_right</mat-icon>
    <span class="breadcrumb-current">{{ cabana.nombre }}</span>
  </nav>

  <!-- Grid Layout -->
  <div class="content-grid">

    <!-- Left Column: Gallery & Description -->
    <div class="left-column">

      <!-- Image Gallery Card -->
      <mat-card class="gallery-card">
        <div class="image-container">
          <!-- Main Image -->
          <div *ngIf="cabana.imagenes && cabana.imagenes.length > 0" class="main-image">
            <img [src]="cabana.imagenes[imagenActual].url"
                 [alt]="cabana.imagenes[imagenActual].descripcion || cabana.nombre">
          </div>

          <!-- Placeholder -->
          <div *ngIf="!cabana.imagenes || cabana.imagenes.length === 0" class="image-placeholder">
            <mat-icon class="placeholder-icon">cottage</mat-icon>
          </div>

          <!-- Navigation Buttons -->
          <div *ngIf="cabana.imagenes && cabana.imagenes.length > 1" class="image-controls">
            <button mat-fab color="primary" class="nav-button prev"
                    (click)="imagenAnterior()"
                    [disabled]="imagenActual === 0">
              <mat-icon>chevron_left</mat-icon>
            </button>
            <button mat-fab color="primary" class="nav-button next"
                    (click)="imagenSiguiente()"
                    [disabled]="imagenActual === cabana.imagenes.length - 1">
              <mat-icon>chevron_right</mat-icon>
            </button>
          </div>

          <!-- Image Counter -->
          <mat-chip *ngIf="cabana.imagenes && cabana.imagenes.length > 1" class="image-counter">
            {{ imagenActual + 1 }} / {{ cabana.imagenes.length }}
          </mat-chip>
        </div>

        <!-- Thumbnails -->
        <div *ngIf="cabana.imagenes && cabana.imagenes.length > 1" class="thumbnails-container">
          <div *ngFor="let imagen of cabana.imagenes; let i = index"
               class="thumbnail"
               [class.active]="i === imagenActual"
               (click)="cambiarImagen(i)">
            <img [src]="imagen.url" [alt]="imagen.descripcion || 'Imagen ' + (i + 1)">
          </div>
        </div>
      </mat-card>

      <!-- Description Card -->
      <mat-card class="description-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>description</mat-icon>
            Descripción
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <p class="description-text">{{ cabana.descripcion || 'Sin descripción disponible' }}</p>

          <mat-divider></mat-divider>

          <h3 class="services-title">
            <mat-icon>check_circle</mat-icon>
            Servicios Incluidos
          </h3>
          <p class="services-text" *ngIf="cabana.serviciosIncluidos">{{ cabana.serviciosIncluidos }}</p>
          <p class="services-text empty" *ngIf="!cabana.serviciosIncluidos">No especificado</p>
        </mat-card-content>
      </mat-card>

      <!-- Location Card -->
      <mat-card class="location-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>place</mat-icon>
            Ubicación
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <p class="location-name">{{ ubicacion.nombre }}</p>

          <!-- Map Placeholder -->
          <div class="map-placeholder">
            <mat-icon class="map-icon">map</mat-icon>
            <p class="map-text">Mapa de ubicación</p>
            <small class="map-coords">{{ ubicacion.lat }}, {{ ubicacion.lng }}</small>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Right Column: Booking Panel -->
    <div class="right-column">
      <mat-card class="booking-card sticky">
        <mat-card-content>

          <!-- Title & Status -->
          <div class="booking-header">
            <h2 class="cabana-title">{{ cabana.nombre }}</h2>
            <mat-chip color="accent" highlighted>{{ cabana.estado }}</mat-chip>
          </div>

          <!-- Price -->
          <div class="price-container">
            <div class="price-amount">${{ cabana.precioPorUnidad?.toLocaleString('es-CL') }}</div>
            <div class="price-unit">por noche</div>
          </div>

          <mat-divider></mat-divider>

          <!-- Date Selector -->
          <div class="date-section">
            <h3 class="section-title">
              <mat-icon>calendar_month</mat-icon>
              Selecciona tus fechas
            </h3>

            <!-- Date Range Picker -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Check-in → Check-out</mat-label>
              <mat-date-range-input
                [formGroup]="rangoFechas"
                [rangePicker]="picker"
                [min]="fechaMinima"
                [dateFilter]="dateFilter">
                <input matStartDate formControlName="start" placeholder="Entrada">
                <input matEndDate formControlName="end" placeholder="Salida">
              </mat-date-range-input>
              <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-date-range-picker #picker></mat-date-range-picker>
              <mat-icon matIconPrefix>event</mat-icon>
            </mat-form-field>

            <!-- Loading Dates -->
            <mat-progress-bar *ngIf="cargandoFechas" mode="indeterminate" class="loading-bar"></mat-progress-bar>

            <!-- Availability Legend -->
            <div class="legend-container">
              <div class="legend-item">
                <div class="legend-color selected"></div>
                <span>Seleccionado</span>
              </div>
              <div class="legend-item">
                <div class="legend-color occupied"></div>
                <span>Ocupado</span>
              </div>
              <div class="legend-item">
                <div class="legend-color today"></div>
                <span>Hoy</span>
              </div>
            </div>

            <!-- Check Availability Button -->
            <button mat-raised-button color="accent" class="full-width-btn"
                    (click)="verificarDisponibilidad()"
                    [disabled]="verificandoDisponibilidad || !fechaInicio || !fechaFin">
              <mat-spinner *ngIf="verificandoDisponibilidad" diameter="20"></mat-spinner>
              <mat-icon *ngIf="!verificandoDisponibilidad">search</mat-icon>
              {{ verificandoDisponibilidad ? 'Verificando...' : 'Verificar Disponibilidad' }}
            </button>

            <!-- Availability Result -->
            <mat-card *ngIf="disponibilidadVerificada && disponible" class="result-card available">
              <mat-card-content>
                <div class="result-header">
                  <mat-icon>check_circle</mat-icon>
                  <strong>¡Disponible!</strong>
                </div>
                <div class="result-details">
                  <small>{{ numeroNoches }} noche(s)</small>
                  <div class="price-breakdown" *ngIf="serviciosSeleccionados.size === 0">
                    <div class="total-price">Total: ${{ formatearPrecio(precioCalculado) }}</div>
                  </div>
                  <div class="price-breakdown" *ngIf="serviciosSeleccionados.size > 0">
                    <small class="breakdown-item">Cabaña: ${{ formatearPrecio(precioCalculado) }}</small>
                    <small class="breakdown-item">Servicios: ${{ formatearPrecio(calcularPrecioConServicios() - precioCalculado) }}</small>
                    <div class="total-price">Total: ${{ formatearPrecio(calcularPrecioConServicios()) }}</div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card *ngIf="disponibilidadVerificada && !disponible" class="result-card unavailable">
              <mat-card-content>
                <div class="result-header">
                  <mat-icon>cancel</mat-icon>
                  <strong>No disponible</strong>
                </div>
                <small>Intenta con otras fechas</small>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Additional Services -->
          <div *ngIf="disponibilidadVerificada && disponible && serviciosDisponibles.length > 0" class="services-section">
            <mat-expansion-panel [expanded]="mostrarServicios">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>add_circle</mat-icon>
                  Agregar Servicios
                </mat-panel-title>
              </mat-expansion-panel-header>

              <p class="services-intro">Complementa tu estadía con nuestros servicios de entretenimiento</p>

              <!-- Loading Services -->
              <div *ngIf="cargandoServicios" class="loading-services">
                <mat-spinner diameter="30"></mat-spinner>
                <small>Cargando servicios...</small>
              </div>

              <!-- Services List -->
              <div *ngIf="!cargandoServicios" class="services-list">
                <mat-card *ngFor="let servicio of serviciosDisponibles"
                          class="service-item"
                          [class.selected]="servicio.id && isServicioSeleccionado(servicio.id)">
                  <mat-card-content *ngIf="servicio.id">
                    <mat-checkbox
                      [checked]="isServicioSeleccionado(servicio.id)"
                      (change)="toggleServicio(servicio.id)">
                      <div class="service-info">
                        <strong class="service-name">{{ servicio.nombre }}</strong>
                        <small class="service-type">{{ servicio.tipoServicio }}</small>
                        <small class="service-price" *ngIf="servicio.precioPorUnidad">
                          ${{ formatearPrecio(servicio.precioPorUnidad) }}/bloque
                        </small>
                      </div>
                    </mat-checkbox>
                    <mat-chip *ngIf="servicio.duracionBloqueMinutos" class="duration-chip">
                      {{ servicio.duracionBloqueMinutos }}min
                    </mat-chip>

                    <!-- Service Options -->
                    <div *ngIf="isServicioSeleccionado(servicio.id)" class="service-options">
                      <mat-divider></mat-divider>

                      <!-- Selector de fecha -->
                      <div class="mb-3">
                        <mat-form-field appearance="outline" class="full-width">
                          <mat-label><i class="bi bi-calendar-event me-2"></i>Fecha</mat-label>
                          <input matInput type="date"
                                 [value]="serviciosSeleccionados.get(servicio.id)?.fecha"
                                 [min]="fechaInicio ? formatearFechaParaBackend(fechaInicio) : ''"
                                 [max]="fechaFin ? formatearFechaParaBackend(fechaFin) : ''"
                                 (change)="actualizarFechaServicio(servicio.id, $any($event.target).value)">
                        </mat-form-field>
                      </div>

                      <!-- Selector de bloques horarios -->
                      <div *ngIf="serviciosSeleccionados.get(servicio.id)?.fecha" class="mb-3">
                        <label class="form-label fw-bold">
                          <i class="bi bi-clock me-2"></i>Selecciona un bloque horario disponible *
                        </label>

                        <!-- Cargando bloques -->
                        <div *ngIf="isCargandoBloquesServicio(servicio.id)" class="text-center py-3">
                          <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Cargando bloques...</span>
                          </div>
                          <span class="ms-2 text-muted">Cargando horarios disponibles...</span>
                        </div>

                        <!-- Bloques disponibles -->
                        <div *ngIf="!isCargandoBloquesServicio(servicio.id) && getBloquesServicio(servicio.id).length > 0" class="bloques-grid mt-2">
                          <div *ngFor="let bloque of getBloquesServicio(servicio.id)"
                               class="bloque-item"
                               [class.selected]="isBloqueSeleccionadoServicio(servicio.id, bloque.id)"
                               (click)="seleccionarBloqueServicio(servicio.id, bloque)">
                            <i class="bi bi-clock"></i>
                            <span>{{ bloque.horaInicio }} - {{ bloque.horaFin }}</span>
                          </div>
                        </div>

                        <!-- Sin bloques disponibles -->
                        <div *ngIf="!isCargandoBloquesServicio(servicio.id) && getBloquesServicio(servicio.id).length === 0" class="alert alert-warning mb-0">
                          <i class="bi bi-exclamation-triangle me-2"></i>
                          No hay horarios disponibles para esta fecha. Por favor selecciona otra fecha.
                        </div>

                        <!-- Bloque seleccionado -->
                        <div *ngIf="serviciosSeleccionados.get(servicio.id)?.bloqueSeleccionado" class="alert alert-success mt-2 mb-0">
                          <i class="bi bi-check-circle me-2"></i>
                          <strong>Horario seleccionado:</strong>
                          {{ serviciosSeleccionados.get(servicio.id)?.bloqueSeleccionado?.horaInicio }} -
                          {{ serviciosSeleccionados.get(servicio.id)?.bloqueSeleccionado?.horaFin }}
                        </div>
                      </div>

                      <!-- Duración (bloques) -->
                      <div class="mb-3">
                        <mat-form-field appearance="outline" class="full-width">
                          <mat-label><i class="bi bi-hourglass me-2"></i>Cantidad de bloques</mat-label>
                          <input matInput type="number" min="1" max="8"
                                 [value]="serviciosSeleccionados.get(servicio.id)?.duracionBloques"
                                 (change)="actualizarServicio(servicio.id, 'duracionBloques', +$any($event.target).value)">
                          <mat-hint *ngIf="servicio.duracionBloqueMinutos">1 bloque = {{ servicio.duracionBloqueMinutos }} minutos</mat-hint>
                        </mat-form-field>
                      </div>
                    </div>
                  </mat-card-content>
                </mat-card>
              </div>

              <!-- Services Summary -->
              <mat-card *ngIf="serviciosSeleccionados.size > 0" class="services-summary">
                <mat-card-content>
                  <small class="summary-title">Servicios agregados:</small>
                  <div *ngFor="let item of serviciosSeleccionados | keyvalue" class="summary-item">
                    <small>{{ item.value.nombre }}</small>
                    <small class="summary-price">
                      ${{ formatearPrecio(calcularPrecioServicio(item.key, item.value.duracionBloques)) }}
                    </small>
                  </div>
                </mat-card-content>
              </mat-card>
            </mat-expansion-panel>
          </div>

          <mat-divider></mat-divider>

          <!-- Features -->
          <div class="features-section">
            <h3 class="section-title">Características</h3>

            <div class="feature-item">
              <div class="feature-icon">
                <mat-icon>people</mat-icon>
              </div>
              <div class="feature-content">
                <small>Capacidad</small>
                <strong>{{ cabana.capacidadPersonas }} personas</strong>
              </div>
            </div>

            <div class="feature-item">
              <div class="feature-icon">
                <mat-icon>meeting_room</mat-icon>
              </div>
              <div class="feature-content">
                <small>Habitaciones</small>
                <strong>{{ cabana.numeroHabitaciones }}</strong>
              </div>
            </div>

            <div class="feature-item">
              <div class="feature-icon">
                <mat-icon>bathroom</mat-icon>
              </div>
              <div class="feature-content">
                <small>Baños</small>
                <strong>{{ cabana.numeroBanos }}</strong>
              </div>
            </div>

            <div class="feature-item">
              <div class="feature-icon">
                <mat-icon>square_foot</mat-icon>
              </div>
              <div class="feature-content">
                <small>Superficie</small>
                <strong>{{ cabana.metrosCuadrados }} m²</strong>
              </div>
            </div>

            <div class="feature-item">
              <div class="feature-icon">
                <mat-icon>star</mat-icon>
              </div>
              <div class="feature-content">
                <small>Categoría</small>
                <strong>{{ cabana.tipoCabana }}</strong>
              </div>
            </div>
          </div>

          <mat-divider></mat-divider>

          <!-- Action Buttons -->
          <div class="actions-section">
            <button mat-raised-button color="primary" class="full-width-btn reserve-btn"
                    (click)="reservar()"
                    [disabled]="!disponibilidadVerificada || !disponible">
              <mat-icon>event_available</mat-icon>
              {{ disponibilidadVerificada && disponible ? 'Reservar Ahora' : 'Verifica disponibilidad primero' }}
            </button>

            <button mat-stroked-button class="full-width-btn" (click)="volver()">
              <mat-icon>arrow_back</mat-icon>
              Volver al catálogo
            </button>
          </div>

          <!-- Info Notice -->
          <mat-card class="info-card">
            <mat-card-content>
              <mat-icon>info</mat-icon>
              <small>Reserva con total confianza. Puedes cancelar hasta 24 horas antes.</small>
            </mat-card-content>
          </mat-card>

        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="footer">
  <div class="footer-content">
    <p>© 2025 Cabañas & Servicios. Todos los derechos reservados.</p>
  </div>
</footer>
